/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/api/Version","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,r,a,t,i,l,s,n,o,u){"use strict";var f={flp:{set(e,r,a){e[r]=[a];return e},get(e,r){return e[r]&&e[r][0]},remove(e,r){delete e[r];return e}},standalone:{set(e,r,a){return u.handleUrlParameters(e,r,a)},get(e,r){return u.getParameter(r)},remove(e,r,a){return u.handleUrlParameters(e,r,a)}}};function v(e){var r=!!u.getParameter(a.UrlParameter,e.URLParsingService);if(r){return Promise.resolve(false)}return i.isVersioningEnabled(e.layer).then(function(r){return r&&s.isDraftAvailable({control:e.selector,layer:e.layer})})}function m(e){var r=this.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);var a=e.layer===n.USER;if(a||r){return Promise.resolve(false)}return l.hasHigherLayerChanges({selector:e.selector,ignoreMaxLayerParameter:e.ignoreMaxLayerParameter,upToLayer:e.layer,includeCtrlVariants:e.includeCtrlVariants,includeDirtyChanges:true}).then(function(r){return r||c(e)})}function c(r){if(o.isOverLayer(n.USER,r.layer)){return t.checkSVMControlsForDirty(e.getFlexReferenceForControl(r.selector))}return false}function h(e){var a=r.get(e.selector);if(a&&a.initialAllContexts){return false}if(a===null||a.allContextsProvided===undefined){var t={selector:e.selector,layer:e.layer};return l.getResetAndPublishInfo(t).then(function(t){if(a===null||!a.initialAllContexts){t.initialAllContexts=true}r.set(t,e.selector);return!t.allContextsProvided})}a.initialAllContexts=true;r.set(a,e.selector);return!a.allContextsProvided}function P(e){var a=r.get(e);return a&&!a.allContextsProvided}function d(e){var a=r.get(e);return a&&a.isEndUserAdaptation===false}var A={getReloadReasonsForStart(e){return Promise.all([m.call(this,e),v(e),h(e)]).then(function(r){[e.hasHigherLayerChanges,e.isDraftAvailable,e.allContexts]=r;return e})},hasVersionParameterWithValue(e,r){return u.hasParameterAndValue(a.UrlParameter,e.value,r)},removeInfoSessionStorage(e){r.remove(e)},hasMaxLayerParameterWithValue(e,r){var a=o.FL_MAX_LAYER_PARAM;return u.hasParameterAndValue(a,e.value,r)},handleUrlParameters(e,t){var i=false;var l=r.get(e.selector)||{};if(!e.ignoreMaxLayerParameter&&e.hasHigherLayerChanges){e.parameters=f[t].remove(e.parameters,o.FL_MAX_LAYER_PARAM,e.layer);delete l.maxLayer;i=true}var s=f[t].get(e.parameters,a.UrlParameter);if(e.versionSwitch&&s!==e.version){e.parameters=f[t].remove(e.parameters,a.UrlParameter,s);e.parameters=f[t].set(e.parameters,a.UrlParameter,e.version);l.version=e.version;i=true}if(s&&e.removeVersionParameter||s===a.Number.Draft&&e.removeDraft){e.parameters=f[t].remove(e.parameters,a.UrlParameter,s);delete l.version;i=true}r.set(l,e.selector);return i},handleParametersOnStart(e,t){var i=false;var l=r.get(e.selector)||{};if(e.hasHigherLayerChanges){e.parameters=f[t].set(e.parameters,o.FL_MAX_LAYER_PARAM,e.layer);l.maxLayer=e.layer;i=true}if(e.isDraftAvailable){e.parameters=f[t].set(e.parameters,a.UrlParameter,a.Number.Draft);l.version=a.Number.Draft;i=true}r.set(l,e.selector);return i},initialDraftGotActivated(e){if(e.versioningEnabled){var r=this.hasVersionParameterWithValue({value:a.Number.Draft},e.URLParsingService);return!s.isDraftAvailable({control:e.selector,layer:e.layer})&&r}return false},getReloadMethod(e){var t={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};e.reloadMethod=t.NOT_NEEDED;e.isDraftAvailable||=A.hasVersionParameterWithValue({value:a.Number.Draft},e.URLParsingService);e.hasVersionUrlParameter=!!u.getParameter(a.UrlParameter,e.URLParsingService);if(e.activeVersion&&e.activeVersion!==a.Number.Original&&e.hasVersionUrlParameter){e.activeVersionNotSelected=!A.hasVersionParameterWithValue({value:e.activeVersion},e.URLParsingService)}e.hasHigherLayerChanges=A.hasMaxLayerParameterWithValue({value:e.layer},e.URLParsingService);e.initialDraftGotActivated=A.initialDraftGotActivated(e);if(e.initialDraftGotActivated){e.isDraftAvailable=false}e.allContexts=P(e.selector);e.switchEndUserAdaptation=d(e.selector);if(e.changesNeedReload||e.isDraftAvailable||e.hasHigherLayerChanges||e.initialDraftGotActivated||e.activeVersionNotSelected||e.allContexts||e.switchEndUserAdaptation){e.reloadMethod=t.RELOAD_PAGE;if(!e.changesNeedReload&&u.getUshellContainer()){e.reloadMethod=t.VIA_HASH}}r.remove(e.selector);return e}};return A});
//# sourceMappingURL=ReloadInfoAPI.js.map