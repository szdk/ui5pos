/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/registry/Settings","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,r,n,t,o,a,i,c,l,s,p,u,g,f){"use strict";var h={};function d(e,t){if(!e.changeSpecificData){return Promise.reject(new Error("No changeSpecificData available"))}if(!e.changeSpecificData.changeType){return Promise.reject(new Error("No valid changeType"))}if(!(e.selectorControl instanceof n)){return Promise.reject(new Error("No valid selectorControl"))}var o=e.selectorControl.getMetadata().getName();return c.getChangeHandler(e.changeSpecificData.changeType,o,e.selectorControl,r,t)}function C(e,n,t){var a=o.getRelevantVariantManagementControlId(n,[],t);return r.getSelector(a,e).id}function m(r){e.error(r);return Promise.reject(r)}var v={add(r){if(!r.changes.length){return Promise.resolve([])}var n=r.changes[0].selectorElement||r.changes[0].selectorControl;var o=f.getAppComponentForControl(n);var c=i.getFlexReference({element:n});var l=p.getChangePersistenceForControl(o);var u=o.getModel(a.getVariantModelName());var m=g.USER;var v=[];function y(){var n=[];var t=[];return r.changes.reduce(function(a,i){return a.then(function(){i.selectorControl=i.selectorElement;return d(i,m)}).then(function(){if(!i.transient&&!r.ignoreVariantManagement){if(!i.changeSpecificData.variantReference){var e=C(o,i.selectorControl,r.useStaticArea);if(e){var n=u.oData[e].currentVariant;i.changeSpecificData.variantReference=n}}}else{delete i.changeSpecificData.variantReference}i.changeSpecificData=Object.assign(i.changeSpecificData,{developerMode:false,layer:m});return s.create({changeSpecificData:i.changeSpecificData,selector:i.selectorControl})}).then(function(e){if(!i.transient){t.push(e)}n.push({changeInstance:e,selectorControl:i.selectorControl})}).catch(function(r){e.error("A Change was not created successfully. Reason: ",r.message)})},Promise.resolve()).then(function(){l.addChanges(t,o);return n}).catch(function(r){e.error("Changes were not added successfully. Reason: ",r.message)})}function I(r){return r.reduce(function(r,n){return r.then(function(){n.changeInstance.setQueuedForApply();return s.apply({change:n.changeInstance,element:n.selectorControl})}).then(function(e){if(e.success){v.push(n.changeInstance)}else{throw e.error||new Error("ChangesWriteAPI.apply failed with unspecified error")}}).catch(function(r){l.deleteChange(n.changeInstance);e.error("A Change was not applied successfully. Reason: ",r.message)})},Promise.resolve())}return t.initialize({componentId:o.getId()}).then(function(){return y().then(I).then(function(){(h[c]||[]).forEach(function(e){e(v)});return v})})},reset(e){if(!e.selectors||e.selectors.length===0){return m("At least one control ID has to be provided as a parameter")}var r=e.selectors[0].appComponent||f.getAppComponentForControl(e.selectors[0]);if(!r){return m("App Component could not be determined")}var n=e.selectors.map(function(e){var n=e.id||e.getId();var t=r.getLocalId(n);return t||n});var o=u.createForControl(r);if(t.isInitialized({control:r})){return o.resetChanges(g.USER,undefined,r,n,e.changeTypes)}return Promise.resolve()},restore(e){if(!e||!e.selector){return Promise.reject("No selector was provided")}var r=f.getAppComponentForControl(e.selector);if(!r){return Promise.reject("App Component could not be determined")}var n=u.createForControl(r);if(t.isInitialized({control:r})){return n.removeDirtyChanges(g.USER,r,e.selector,e.generator,e.changeTypes)}return Promise.resolve()},hasDirtyFlexObjects(e){if(!e||!e.selector){throw Error("No selector was provided")}var n=f.getAppComponentForControl(e.selector);if(!n){throw Error("App Component could not be determined")}var t=p.getChangePersistenceForControl(n);var o=t.getDirtyChanges();return o.some(function(t){if(t.getLayer()!==g.USER){return false}if(e.generator&&t.getSupportInformation().generator!==e.generator){return false}if(e.changeTypes&&e.changeTypes.indexOf(t.getChangeType())===-1){return false}var o=t.getSelector();return e.selector.getId()===r.getControlIdBySelector(o,n)})},save(e){var r=e.selector.appComponent||f.getAppComponentForControl(e.selector);if(!r){return m("App Component could not be determined")}var n=u.createForControl(r);if(t.isInitialized({control:r})){return n.saveSequenceOfDirtyChanges(e.changes,r)}return Promise.resolve()},buildSelectorFromElementIdAndType(e){var r=f.getAppComponentForControl(e.element);if(!r||!e.elementId||!e.elementType){throw new Error("Not enough information given to build selector.")}return{elementId:e.elementId,elementType:e.elementType,appComponent:r,id:e.elementId,controlType:e.elementType}},isCondensingEnabled(){return l.getInstance().then(function(e){return e.isCondensingEnabled(g.USER)})},attachChangeCreation(e,r){var n=i.getFlexReference({element:e});h[n]=(h[n]||[]).concat(r)},detachChangeCreation(e,r){var n=i.getFlexReference({element:e});if(Array.isArray(h[n])){h[n]=h[n].filter(function(e){return e!==r})}},detachAllChangeCreationListeners(e){if(e){var r=i.getFlexReference({element:e});delete h[r]}else{h={}}}};return v});
//# sourceMappingURL=ControlPersonalizationWriteAPI.js.map