/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/flexState/FlexObjectState","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,r,t,n,a,s,o,i,l,c,u,g,f,h,p,d,C,y){"use strict";var v={};function b(r){return r._getMap&&e(s.getChangeTypes(),r._getMap().changeType)||r.getChangeType&&e(s.getChangeTypes(),r.getChangeType())}function m(e){e.includeCtrlVariants=true;e.invalidateCache=false;return v._getUIChanges(e).then(function(e){return e.length>0})}v.hasDirtyChanges=function(e){return c.hasDirtyFlexObjects(e)};v.hasHigherLayerChanges=function(e){e.upToLayer||=C.getCurrentLayer();return c.getFlexObjects(e).then(function(r){return r.filter(function(r){return C.isOverLayer(r.getLayer(),e.upToLayer)})}).then(function(e){return e.length>0})};v.save=function(e){return c.saveFlexObjects(e).then(function(r){if(r&&r.length!==0){return v.getResetAndPublishInfo(e).then(function(t){var n=f.get(e.selector)||{};f.set(Object.assign(n,t),e.selector);return r})}return r})};v.getResetAndPublishInfo=function(e){return Promise.all([m(e),g.isPublishAvailable()]).then(function(r){var n=r[0];var a=r[1];var s=e.layer!==d.USER&&e.layer!==d.PUBLIC;var o={isResetEnabled:n,isPublishEnabled:false,allContextsProvided:true};if(s){return u.getFlexInfo(e).then(function(e){o.allContextsProvided=e.allContextsProvided===undefined||e.allContextsProvided;o.isResetEnabled=e.isResetEnabled;o.isPublishEnabled=a&&e.isPublishEnabled;return o}).catch(function(e){t.error(`Sending request to flex/info route failed: ${e.message}`);return o})}return o})};v.getResetAndPublishInfoFromSession=function(e){var r=o.getFlexReferenceForControl(e)||"true";return JSON.parse(window.sessionStorage.getItem(`sap.ui.fl.info.${r}`))};v.reset=function(e){var r=y.getAppComponentForSelector(e.selector);var t=p.createForSelector(r);return t.resetChanges(e.layer,e.generator,r,e.selectorIds,e.changeTypes)};v.publish=function(e){e.styleClass||="";return h.getChangePersistenceForControl(y.getAppComponentForSelector(e.selector)).transportAllUIChanges({},e.styleClass,e.layer,e.appVariantDescriptors)};v.add=function(e){var r=y.getAppComponentForSelector(e.selector);var t=o.getFlexReferenceForSelector(e.selector);var n=h.getChangePersistenceForComponent(t);function a(e){if(b(e)){return e.store()}return n.addChange(e,r)}if(e.change&&e.flexObjects){throw new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property.")}if(e.change){return a(e.change)}var s=e.flexObjects.some(function(e){return b(e)});if(s){return e.flexObjects.map(a)}return n.addChanges(e.flexObjects,r)};v.remove=function(e){return Promise.resolve().then(function(){if(e.change&&e.flexObjects){return Promise.reject(new Error("Using 'flexObjects' and 'change' properties together not supported. Please use the 'flexObjects' property."))}if(!e.selector){return Promise.reject(new Error(`An invalid selector was passed so change could not be removed with id: ${e.change.getId()}`))}var r=y.getAppComponentForSelector(e.selector);if(!r){return Promise.reject(new Error(`Invalid application component for selector, change could not be removed with id: ${e.change.getId()}`))}var t=h.getChangePersistenceForControl(r);function s(e){var t=n.bySelector(e.getSelector(),r);if(t){a.destroyAppliedCustomData(t,e,n)}}if(e.change){if(!b(e.change)){s(e.change)}return t.deleteChange(e.change)}e.flexObjects.forEach(function(e){if(!b(e)){s(e)}});return t.deleteChanges(e.flexObjects)})};v.getChangesWarning=function(e){return this._getUIChanges(e).then(function(e){var r=e.some(function(e){return e.isChangeFromOtherSystem()});var t=i.getInstanceOrUndef();var n=t&&t.isProductiveSystemWithTransports();var a=e.length===0;var s={showWarning:false};if(r){s={showWarning:true,warningType:"mixedChangesWarning"}}if(n&&a){s={showWarning:true,warningType:"noChangesAndPSystemWarning"}}return s})};v._condense=function(e){return Promise.resolve().then(function(){if(!e.selector){throw Error("An invalid selector was passed")}var r=y.getAppComponentForSelector(e.selector);if(!r){throw Error("Invalid application component for selector")}if(!e.changes||e.changes&&!Array.isArray(e.changes)){throw Error("Invalid array of changes")}return l.condense(r,e.changes)})};v._getUIChanges=function(e){if(e.layer){e.currentLayer=e.layer}return c.getFlexObjects(e)};return v});
//# sourceMappingURL=PersistenceWriteAPI.js.map