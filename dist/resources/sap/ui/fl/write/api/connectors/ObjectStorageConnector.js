/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/hash","sap/base/util/restricted/_uniqBy","sap/base/util/each","sap/base/util/merge","sap/ui/fl/write/connectors/BaseConnector","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/apply/_internal/connectors/ObjectStorageUtils"],function(e,t,r,n,a,i,s){"use strict";function o(e){var t=[];return s.forEachObjectInStorage(e,function(e){t.push(e.changeDefinition)}).then(function(){return t})}function c(e,t){var r=true;if(e.selectorIds){if(t.selector){r=e.selectorIds.indexOf(t.selector.id)>-1}else{r=false}}if(r&&e.changeTypes){r=e.changeTypes.indexOf(t.changeType)>-1}return r}function u(e,t){if(!e.creation){var r=Date.now()+t;e.creation=new Date(r).toISOString()}return e}function f(t){return e(t.reduce(function(e,t){return e+new Date(t.creation).getTime()},""))}function l(e,t){r(e,function(e,n){n.forEach(function(e){r(e,function(e,r){t(r,e)})})})}function g(e,t){var r=[];var n=0;l(e,function(e,a){var i=s.createFlexKey(a);var o=t.find(function(t){return t.getId()===e.fileName});if(!o.getCreation()){var c=Date.now()+n;n++;o.setCreation(new Date(c).toISOString())}r.push({key:i,value:o})});return r}function h(e,t){var r=[];l(e,function(e,n){var a=s.createFlexKey(n);var i;t.some(function(e){if(e.getId()===n){i=e;return true}});r.push({key:a,value:i})});return r}function v(e,t){var n=[];r(e,function(e,r){if(r.length<2){return}var a=t.filter(function(t){return t.getFileType()===e});a.forEach(function(e,t){if(r.indexOf(e.getId())>-1&&t<a.length-1){var i=a[t+1];var o=new Date(e.getCreation());var c=new Date(i.getCreation());if(i&&o>=c){var u=o.getTime()+1;i.setCreation(new Date(u).toISOString());var f=s.createFlexKey(i.getId());n.push({key:f,value:i})}}})});return n}function d(e){var t=[];if(e){Object.values(e).forEach(function(e){e.forEach(function(e){var r=s.createFlexKey(e);t.push(this.storage.removeItem(r))}.bind(this))}.bind(this))}return t}var b=n({},a,{storage:undefined,layers:["ALL"],loadFlexData(e){return o({storage:this.storage,reference:e.reference}).then(function(e){i.sortFlexObjects(e);var t=i.getGroupedFlexObjects(e);var r=i.filterAndSortResponses(t);if(r.length){r[0].cacheKey=f(e)}return r})},async write(e){let t=0;const r=[];for(const n of e.flexObjects){const e=s.createFlexObjectKey(n);const a=u(n,++t);const i=this.storage._itemsStoredAsObjects?a:JSON.stringify(a);await this.storage.setItem(e,i);r.push(a)}return{response:r}},update(e){var t=e.flexObject;var r=s.createFlexObjectKey(e.flexObject);var n=this.storage._itemsStoredAsObjects?t:JSON.stringify(t);var a=this.storage.setItem(r,n);return Promise.resolve(a)},reset(e){return s.forEachObjectInStorage({storage:this.storage,reference:e.reference,layer:e.layer},function(t){if(c(e,t.changeDefinition)){return Promise.resolve(this.storage.removeItem(t.key)).then(function(){return{fileName:t.changeDefinition&&t.changeDefinition.fileName}})}}.bind(this)).then(function(e){return{response:e.filter(function(e){return!!e})}})},remove(e){var t=s.createFlexObjectKey(e.flexObject);this.storage.removeItem(t);var r=this.storage.removeItem(t);return Promise.resolve(r)},loadFeatures(){return Promise.resolve({isKeyUser:true,isVariantSharingEnabled:true,isProductiveSystem:false,isCondensingEnabled:true,isContextSharingEnabled:false})},getFlexInfo(e){e.storage=this.storage;return s.getAllFlexObjects(e).then(function(e){return{isResetEnabled:e.length>0}})},condense(e){var r=e.flexObjects;var n=[];n=n.concat(g(r.create,e.condensedChanges));n=n.concat(h(r.update,e.condensedChanges));n=n.concat(v(r.reorder,e.condensedChanges));n=t(n,"key");var a=[];a=a.concat(d.call(this,r.delete));n.forEach(function(e){var t=e.value.convertToFileContent();var r=this.storage._itemsStoredAsObjects?t:JSON.stringify(t);a.push(this.storage.setItem(e.key,r))}.bind(this));return Promise.all(a)}});return b});
//# sourceMappingURL=ObjectStorageConnector.js.map