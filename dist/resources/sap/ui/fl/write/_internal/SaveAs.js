/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/appVariant/AppVariantFactory","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,t,r,n,a,i,o,s,c,u){"use strict";function p(e){return a.getInstance().then(function(t){if(!e.package&&(e.layer===c.VENDOR||e.layer===c.CUSTOMER_BASE&&!t.isAtoEnabled())){return Promise.reject("Package must be provided or is valid")}if(e.isForSmartBusiness&&(e.package!=="$TMP"&&e.package!=="")&&!e.transport&&!t.isAtoEnabled()){return Promise.reject("Transport must be provided")}if(e.isForSmartBusiness&&e.transport||e.package==="$TMP"){return Promise.resolve({packageName:e.package,transport:e.transport})}return Promise.resolve({packageName:"",transport:""})})}function l(e,t){var r=t.transport?e.setTransportRequest(t.transport):Promise.resolve();return r.then(function(){if(t.packageName){return e.setPackage(t.packageName)}return Promise.resolve()})}function f(e){var t=[];e.forEach(function(e){var r={changeType:e.getChangeType(),content:e.getContent()};if(e.getTexts()){r.texts=e.getTexts()}t.push(o.createNew(r))});return Promise.all(t)}function h(e,t){var r={reference:t.getId()};var n=u.createNamespace(r,"changes");var a=e.getFlexObjectMetadata();a.namespace=n;a.reference=t.getId();e.setFlexObjectMetadata(a)}function g(e,t){var r=[];e.forEach(function(e){e.replaceHostingIdForTextKey(t.getId(),t.getReference(),e.getContent(),e.getTexts());r.push(t.addDescriptorInlineChange(e))});return Promise.all(r)}function d(e){var t=s.createForSelector(e)._oChangePersistence;if(!t){return[]}return t.getDirtyChanges().filter(function(e){return n.getChangeTypes().includes(e.getChangeType())})}function A(e){var t=s.createForSelector(e)._oChangePersistence;if(!t){return[]}var r=t.getDirtyChanges();r=r.slice();return r}function m(e){var t=[];d(e).forEach(function(e){if(n.getChangeTypes().includes(e.getChangeType())){t.push(e)}});s.createForSelector(e)._oChangePersistence.deleteChanges(t)}function v(e,t){if(!e){throw new Error(`App variant with ID: ${t.id}does not exist`)}t.package=e.getPackage();t.layer=e.getDefinition().layer;return p(t).then(function(t){return l(e,t)}).then(function(){return e})}var P={saveAs(e){var a;var o;return i.prepareCreate(e).then(function(r){a=t({},r);return p(e)}).then(function(e){return l(a,e)}).then(function(){var t=[];A(e.selector).forEach(function(e){if(n.getChangeTypes().includes(e.getChangeType())){t.push(e)}else{h(e,a)}});return f(t)}).then(function(e){return g(e,a)}).then(function(){return a.submit().catch(function(e){e.messageKey="MSG_SAVE_APP_VARIANT_FAILED";throw e})}).then(function(r){o=t({},r);m(e.selector);var n=s.createForSelector(e.selector);var a=A(e.selector);if(a.length){return n.saveAll(u.getAppComponentForSelector(e.selector),true).catch(function(t){return this.deleteAppVariant({id:e.id}).then(function(){t.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw t})}.bind(this))}return Promise.resolve()}.bind(this)).then(function(){return o}).catch(function(t){if(d(e.selector).length){m(e.selector)}r.error("the app variant could not be created.",t.message||t);throw t})},updateAppVariant(a){var o;var s;return i.prepareUpdate(e(a,"selector")).catch(function(e){e.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw e}).then(function(e){if(!e){throw new Error(`App variant with ID: ${a.id}does not exist`)}o=t({},e);a.package=o.getPackage();a.layer=o.getDefinition().layer;return p(a)}).then(function(e){return l(o,e)}).then(function(){var e=[];d(a.selector).forEach(function(t){if(n.getChangeTypes().includes(t.getChangeType())){e.push(t)}});return f(e)}).then(function(e){return g(e,o)}).then(function(){return o.submit().catch(function(e){if(a.isForSmartBusiness){m(a.selector);throw e}e.messageKey="MSG_UPDATE_APP_VARIANT_FAILED";throw e})}).then(function(e){s=t({},e);m(a.selector);return s}).catch(function(e){if(d(a.selector).length){m(a.selector)}r.error("the app variant could not be updated.",e.message||e);throw e})},deleteAppVariant(t){return i.prepareDelete(e(t,"selector")).catch(function(e){e.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw e}).then(function(e){return t.isForSmartBusiness?Promise.resolve(e):v(e,t)}).then(function(e){return e.submit().catch(function(e){if(e==="cancel"){return Promise.reject("cancel")}e.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw e})}).catch(function(e){if(e==="cancel"){return Promise.reject("cancel")}r.error("the app variant could not be deleted.",e.message||e);throw e})}};return P});
//# sourceMappingURL=SaveAs.js.map