/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync"],function(e,n,t,r,a,i,c,s,o,f,p,u,l,d,g,m,h,v){"use strict";var x={};var b={};var O={};var R;var j={appDescriptorChanges:{prepareFunction:o,pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",prepareFunction:f,pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:p,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var y={compVariants:{},flexObjects:{}};function I(e,n){var t={comp(){return Object.values(n).reduce(function(e,n){return e.concat(n)},[])},variants(){return n.map(function(e){var t=e.variantReference===e.variantManagementReference||n.some(function(n){return n.variantManagementReference===e.variantManagementReference&&n.fileName===e.variantReference});if(!t){return Object.assign({},e,{variantReference:e.variantManagementReference})}return e})}}[e];if(t){return t()}return Array.isArray(n)?n:[]}function S(e){var n=i.getComponentById(e.componentId);e.componentData||=n&&n.getComponentData()||{};e.manifest||=e.rawManifest||n&&n.getManifestObject()||{};e.reference||=g.getFlexReference(e)}function C(e){var t=[];n(e.changes,function(e,n){I(e,n).forEach(function(e){t.push(c.createFromFileContent(e,null,true))})});return t}function D(e,n){var t=j[e].initialPreparationFunctionName;var r=l[t];if(r){return r(n)}return undefined}function F(e,n,t){var r=D(e,n);if(r){V(t,r)}}var P=new u({id:"flexObjects",parameterKey:"reference",executeFunction(e,n){if(!b[n]){return[]}var t=b[n].runtimePersistence;return t.flexObjects.concat(t.runtimeOnlyData.flexObjects||[],y.flexObjects[n][b[n].componentId]||[])}});function _(e,n){if(!b[e]){throw new Error("State is not yet initialized")}if(!b[e].preparedMaps[n]){var t={unfilteredStorageResponse:b[e].unfilteredStorageResponse,storageResponse:b[e].storageResponse,componentId:b[e].componentId,componentData:b[e].componentData,reference:e,runtimePersistence:b[e].runtimePersistence};b[e].preparedMaps[n]=x.callPrepareFunction(n,t);F(n,t,e)}return b[e].preparedMaps[n]}function V(e,n){b[e]=t(b[e],n);P.checkUpdate({reference:e})}function M(e){return _(e,"appDescriptorChanges")}function k(e){return _(e,"changes")}function z(e){return _(e,"compVariants")}function N(e,n){var r={flexObjects:C(e),runtimeOnlyData:{flexObjects:[]}};Object.keys(j).forEach(function(a){var i=D(a,{storageResponse:e,externalData:n});if(i){r=t(r,i)}});return r}function U(e,t,r){var a=r.flexObjects.slice();var i=a.length;var c;var o=[];n(t.changes,function(e,n){I(e,n).forEach(function(e){o.push(e)})});b[e].runtimePersistence=Object.assign(r,{flexObjects:o.map(function(e){var n;var t=a.find(function(t,r){n=r;return t.getId()===e.fileName});if(t){a.splice(n,1);if(t.getState()!==s.LifecycleState.PERSISTED){t.setResponse(e);c=true}return t}throw new Error("Error updating runtime persistence: storage returned unknown flex objects")})});if(i!==b[e].runtimePersistence.flexObjects.length){c=true}return c}function w(e){var n=e.reference;var t=false;if(!b[n].componentData){var a=i.getComponentById(e.componentId);b[n].componentData=a?a.getComponentData():e.componentData;t=true}if(!b[n].storageResponse){b[n].storageResponse=E(n,b[n].unfilteredStorageResponse);delete b[n].runtimePersistence;t=true}if(!r.get(["flexObjects",n,e.componentId],y)){r.set(["flexObjects",n,e.componentId],[],y)}if(!b[n].runtimePersistence){b[n].runtimePersistence=N(b[n].storageResponse,y.flexObjects[n][e.componentId]||[]);t=true}if(t){P.checkUpdate({reference:n})}}function E(e,a){const i=t({},a);const c=i.changes;if(h.isLayerFilteringRequired(e)){const t=m.getByReference(e);n(j,function(e,n){n.pathInResponse.forEach(function(e){const n=r.get(e,c).filter(function(e){return!e.layer||!h.isOverLayer(e.layer,t.maxLayer)});r.set(e,n,c)})})}return i}function L(e){O[e.reference]=d.loadFlexData(e).then(function(n){b[e.reference]=t({},{unfilteredStorageResponse:n,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});A(e.reference,n);Object.freeze(b[e.reference].storageResponse);Object.freeze(b[e.reference].unfilteredStorageResponse);return n});return O[e.reference]}function A(e,n){var t=n&&n.changes||{};var r=m.getByReference(e);if(r===null){r={}}if(t.info!==undefined){r=Object.assign(r,t.info)}m.setByReference(r,e)}function B(e){var n=b[e.reference];if(n.partialFlexState===true&&e.partialFlexState!==true){n.partialFlexState=false;e.partialFlexData=t({},n.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function q(e){var n=b[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}function K(){return v("sap/ui/fl/ChangePersistenceFactory").then(function(e){R=e}).catch(function(e){a.error(`Error loading modules: ${e.message}`)})}x.initialize=function(e){return Promise.all([K()]).then(function(){S(e);var n=e.reference;if(O[n]){return O[n].then(B.bind(null,e)).then(q).then(function(e){return e.reInitialize?L(e):b[n].unfilteredStorageResponse})}return L(e)}).then(function(e){w(e)}.bind(null,e))};x.isInitialized=function(e){var n=e.reference?e.reference:g.getFlexReferenceForControl(e.control);return!!b[n]};x.clearAndInitialize=function(e){S(e);x.clearState(e.reference);return x.initialize(e)};x.update=function(e){S(e);var n=e.reference;var t=b[n].runtimePersistence;if(R&&(R._instanceCache||{}).hasOwnProperty(n)){R._instanceCache[n].removeDirtyChanges()}return(O[n]||Promise.resolve()).then(L.bind(this,e)).then(function(){b[n].storageResponse=E(n,b[n].unfilteredStorageResponse);var e=U(n,b[n].storageResponse,t);if(e){P.checkUpdate({reference:n})}})};function T(e){switch(e.fileType){case"change":if(e.selector&&e.selector.persistencyKey){return["comp","changes"]}if(e.variantReference){return"variantDependentControlChanges"}return"changes";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";case"variant":return["comp","variants"];default:return""}}x.updateStorageResponse=function(e,n){n.forEach(n=>{if(n.type==="ui2"){b[e].unfilteredStorageResponse.changes.ui2personalization=n.newData}else{const t=T(n.flexObject);const a=n.flexObject.fileName;const i=r.get(t,b[e].unfilteredStorageResponse.changes);const c=r.get(t,b[e].storageResponse.changes);switch(n.type){case"add":i.push(n.flexObject);c.push(n.flexObject);break;case"delete":c.splice(c.findIndex(e=>e.fileName===a),1);i.splice(i.findIndex(e=>e.fileName===a),1);break;case"update":c.splice(c.findIndex(e=>e.fileName===a),1,n.flexObject);i.splice(i.findIndex(e=>e.fileName===a),1,n.flexObject);break;default:}}})};x.clearState=function(e){if(e){delete b[e];delete O[e];P.clearCachedResult({reference:e});if(R&&(R._instanceCache||{}).hasOwnProperty(e)){R._instanceCache[e].removeDirtyChanges()}}else{b={};O={};P.clearCachedResult()}};x.setInitialNonFlCompVariantData=function(e,n,t,r,a){y.compVariants[e]||={};y.compVariants[e][n]={};y.compVariants[e][n].standardVariant=t;y.compVariants[e][n].variants=r;y.compVariants[e][n].controlId=a};x.getInitialNonFlCompVariantData=function(e){return y.compVariants[e]};x.resetInitialNonFlCompVariantData=function(e){delete y.compVariants[e]};x.addRuntimeSteadyObject=function(e,n,t){y.flexObjects[e]||={};y.flexObjects[e][n]||=[];y.flexObjects[e][n].push(t);P.checkUpdate({reference:e})};x.clearRuntimeSteadyObjects=function(e,n){if(y.flexObjects[e]){delete y.flexObjects[e][n];P.clearCachedResult({reference:e})}};x.rebuildFilteredResponse=function(e){if(b[e]){b[e].preparedMaps={};b[e].storageResponse=E(e,b[e].unfilteredStorageResponse);b[e].runtimePersistence=N(b[e].storageResponse,y.flexObjects[e][b[e].componentId]||[]);P.checkUpdate({reference:e})}};x.addDirtyFlexObject=function(e,n){if(b[e]){b[e].runtimePersistence.flexObjects.push(n);P.checkUpdate({reference:e})}};x.addDirtyFlexObjects=function(e,n){if(n.length>0&&b[e]){b[e].runtimePersistence.flexObjects=b[e].runtimePersistence.flexObjects.concat(n);P.checkUpdate({reference:e})}};x.removeDirtyFlexObject=function(e,n){if(b[e]){var t=b[e].runtimePersistence.flexObjects;var r=t.indexOf(n);t.splice(r,1);P.checkUpdate({reference:e})}};x.removeDirtyFlexObjects=function(e,n){if(b[e]&&n.length>0){var t=b[e].runtimePersistence.flexObjects;n.forEach(function(e){var n=t.indexOf(e);t.splice(n,1)});P.checkUpdate({reference:e})}};x.getFlexObjectsDataSelector=function(){return P};x.getUIChanges=function(e){return k(e).changes};x.getAppDescriptorChanges=function(e){return M(e).appDescriptorChanges};x.getUI2Personalization=function(e){return t({},b[e].unfilteredStorageResponse.changes.ui2personalization)};x.getCompVariantsMap=function(e){return z(e)};x.callPrepareFunction=function(e,n){return j[e].prepareFunction(n)};x.getStorageResponse=function(e){if(O[e]){return O[e].then(function(){return b[e].unfilteredStorageResponse})}return Promise.resolve()};x.getComponentData=function(e){return b[e]&&b[e].componentData};return x});
//# sourceMappingURL=FlexState.js.map