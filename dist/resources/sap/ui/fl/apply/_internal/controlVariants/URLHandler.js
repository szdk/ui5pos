/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/base/Log","sap/base/util/deepEqual","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher","sap/base/util/includes","sap/ui/fl/apply/_internal/controlVariants/Utils"],function(e,a,r,t,n,o,i,s,l,p){"use strict";var m={};var c={};function d(e,a){var r=[];return e.reduce(function(e,t){var n=a.getVariantManagementReference(t).variantManagementReference;if(n){if(l(r,n)){e.updateRequired=true;return e}r.push(n)}if(n&&a.oData[n].currentVariant!==t){e.updateRequired=true;if(a.oData[n].currentVariant!==a.oData[n].defaultVariant){e.parameters.push(a.oData[n].currentVariant)}}else{e.parameters.push(t)}return e},{updateRequired:false,parameters:[]})}function u(e,a){var r=n.get(["params",p.VARIANT_TECHNICAL_PARAMETER],e);if(r){var t=d(r,a);if(t.updateRequired){c.update({updateURL:!a._bDesignTimeMode,parameters:t.parameters,updateHashEntry:true,model:a})}}}function f(e,r){try{var t=e.getUShellService("URLParsing");if(t){var n=t.parseShellHash(r);u(n,e)}}catch(e){a.error(e.message)}var o=e.getUShellService("ShellNavigation");return o&&o.NavigationFilterStatus.Continue}function v(e){var a=e.getUShellService("ShellNavigation");if(!m[e.sFlexReference]){m[e.sFlexReference]=f.bind(null,e);if(a){a.registerNavigationFilter(m[e.sFlexReference])}}}function A(e){var a=e.getUShellService("ShellNavigation");if(a){a.unregisterNavigationFilter(m[e.sFlexReference]);delete m[e.sFlexReference]}}function h(e){var t=e.model;var n=t.getUShellService("URLParsing");var o=t.getUShellService("CrossApplicationNavigation");var i=n&&n.parseShellHash(s.getHash());if(i&&i.params){var l=Object.assign({},i.params);var m=t.oAppComponent&&t.oAppComponent.getComponentData&&t.oAppComponent.getComponentData()&&t.oAppComponent.getComponentData().technicalParameters;if(!m){a.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged")}if(e.parameters.length===0){delete i.params[p.VARIANT_TECHNICAL_PARAMETER];m&&delete m[p.VARIANT_TECHNICAL_PARAMETER]}else{i.params[p.VARIANT_TECHNICAL_PARAMETER]=e.parameters;m&&(m[p.VARIANT_TECHNICAL_PARAMETER]=e.parameters)}if(e.silent){s.changed.active=false;s.replaceHash(n.constructShellHash(i));s.changed.active=true}else if(!r(l,i.params)){o.toExternal({target:{semanticObject:i.semanticObject,action:i.action,context:i.contextRaw},params:i.params,appSpecificRoute:i.appSpecificRoute,writeHistory:false})}}}function R(e){var a={index:-1};var r=e.model;var n=r.getUShellService("URLParsing");var i=n&&n.parseShellHash(s.getHash()).params;if(i){a.parameters=[];if(r._bDesignTimeMode){i[p.VARIANT_TECHNICAL_PARAMETER]=c.getStoredHashParams(e)}if(Array.isArray(i[p.VARIANT_TECHNICAL_PARAMETER])){i[p.VARIANT_TECHNICAL_PARAMETER]=i[p.VARIANT_TECHNICAL_PARAMETER].map(decodeURIComponent);i[p.VARIANT_TECHNICAL_PARAMETER].some(function(t,n){if(!o(r.getVariant(t,e.vmReference))){a.index=n;return true}return false})}}return t(a,i&&i[p.VARIANT_TECHNICAL_PARAMETER]&&{parameters:i[p.VARIANT_TECHNICAL_PARAMETER]})}function g(e){var a=e.getUShellService("URLParsing");var r=a&&a.parseShellHash(s.getHash());return r&&r.params&&r.params[p.VARIANT_TECHNICAL_PARAMETER]}c.variantTechnicalParameterName="sap-ui-fl-control-variant-id";c.initialize=function(e){var a=e.model;var r=a.getUShellService("URLParsing");var t=r&&r.parseShellHash(s.getHash());var n=t&&t.params&&t.params[p.VARIANT_TECHNICAL_PARAMETER];c.attachHandlers(e);c.update({model:a,parameters:n,updateHashEntry:Array.isArray(n)&&n.length>0});u(t,a)};c.updateVariantInURL=function(e){var a=c.removeURLParameterForVariantManagement(e);if(!a.parameters){return}var r=a.parameters||[];var t=a.index;var n=e.newVReference===e.model.oData[e.vmReference].defaultVariant;if(!n){if(t===-1){r=r.concat([e.newVReference])}else{r=r.slice(0,t).concat([e.newVReference],r.slice(t))}}if(!n||t>-1){c.update({parameters:r,updateURL:!e.model._bDesignTimeMode,updateHashEntry:true,model:e.model})}};c.removeURLParameterForVariantManagement=function(e){var a=R(e);if(a.index>-1){a.parameters.splice(a.index,1)}return a};c.attachHandlers=function(a){function r(){return a.model._oVariantSwitchPromise.then(function(){a.model._oHashData.controlPropertyObservers.forEach(function(e){e.destroy()});A(a.model);a.model.destroy();a.model.oComponentDestroyObserver.unobserve(a.model.oAppComponent,{destroy:true});a.model.oComponentDestroyObserver.destroy()})}v(a.model);if(!a.model.oComponentDestroyObserver&&a.model.oAppComponent instanceof e){a.model.oComponentDestroyObserver=new i(r.bind(null));a.model.oComponentDestroyObserver.observe(a.model.oAppComponent,{destroy:true})}};c.registerControl=function(e){if(e.updateURL){e.model._oHashData.variantControlIds.push(e.vmReference)}};c.update=function(e){e.model._oHashData||={hashParams:[],controlPropertyObservers:[],variantControlIds:[]};if(!e||!Array.isArray(e.parameters)){a.info("Variant URL parameters could not be updated since invalid parameters were received");return}if(e.updateURL){h(e)}if(e.updateHashEntry&&!o(e.model)){e.model._oHashData.hashParams=e.parameters}};c.getStoredHashParams=function(e){return Array.prototype.slice.call(e.model._oHashData.hashParams)};c.handleModelContextChange=function(e){var a="modelContextChange";function r(a,r){var t=r.model.getVariantManagementReferenceForControl(a.getSource());var n=r.model._oHashData.variantControlIds;var o=n.indexOf(t);if(o>-1){n.slice(o).forEach(function(a){if(R({vmReference:a,model:e.model}).index===-1){r.model.switchToDefaultForVariantManagement(a)}})}}var t=new i(function(t){if(t.current===true&&t.old===false){t.object.attachEvent(a,{model:e.model},r)}else if(t.current===false&&t.old===true){t.object.detachEvent(a,r)}});t.observe(e.vmControl,{properties:["resetOnContextChange"]});e.model._oHashData.controlPropertyObservers.push(t);if(e.vmControl.getResetOnContextChange()!==false){e.vmControl.attachEvent(a,{model:e.model},r)}};c.clearAllVariantURLParameters=function(e){if(g(e.model)){c.update({updateURL:true,parameters:[],updateHashEntry:false,model:e.model})}};return c});
//# sourceMappingURL=URLHandler.js.map