/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/base/Log"],function(e,n,t,r,i,a,o,s,h,p,u,c){"use strict";function f(e,n,t){return Promise.resolve().then(function(){if(t.length!==0){t.reverse();return a.revertMultipleChanges(t,{appComponent:e,modifier:p,flexController:this})}return undefined}.bind(this)).then(function(){if(e){var r=e.getModel(h.getVariantModelName());if(r){if(!n){o.update({parameters:[],updateURL:true,updateHashEntry:true,model:r})}}}return t})}var l=function(e){this._oChangePersistence=undefined;this._sComponentName=e||"";if(this._sComponentName){this._oChangePersistence=t.getChangePersistenceForComponent(this._sComponentName)}};l.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};l.prototype.waitForVariantSwitch=function(){this._oVariantSwitchPromise||=Promise.resolve();return this._oVariantSwitchPromise};function d(n,t,r,i,a){var o=g(n,i);if(!o){return[]}a.push(n);var s=n.getId();var h=t[s]&&t[s].dependencies||[];for(var p=0,u=h.length;p<u;p++){var c=e.getChangeFromChangesMap(r,h[p]);o=d(c,t,r,i,a);if(o.length===0){a=[];break}delete t[s]}return a}function g(e,n){var t=e.getDependentControlSelectorList();t.push(e.getSelector());return!t.some(function(e){return!p.bySelector(e,n)})}l.prototype.waitForChangesToBeApplied=function(e){var n=e.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(n).then(function(){return undefined})};l.prototype._waitForChangesToBeApplied=function(n){function t(e){return!e.isCurrentProcessFinished()&&(n.changeTypes.length===0||n.changeTypes.includes(e.getChangeType()))}n.changeTypes||=[];var r=n.selector.id&&u.getElementById(n.selector.id)||n.selector;var i=this._oChangePersistence.getChangesMapForComponent();var a=[];var o=Object.assign({},i.mDependencies);var{mChanges:s}=i;var h=s[r.getId()]||[];var p=h.filter(t);var c=n.selector.appComponent||e.getAppComponentForControl(r);var f=[];p.forEach(function(e){var n=d(e,o,i.mChanges,c,[]);n.forEach(function(e){if(f.indexOf(e)===-1){f.push(e)}})});f.forEach(function(e){a=a.concat(e.addChangeProcessingPromises())},this);a.push(this.waitForVariantSwitch());return Promise.all(a)};l.prototype._removeOtherLayerChanges=function(e,t,r){if(r&&t){var i=Object.values(n).filter(function(e){return e!==t});return this.removeDirtyChanges(i,e,undefined,undefined,undefined,true)}return Promise.resolve()};l.prototype.saveAll=function(e,t,i,a,o,s){var h;var p;if(i){var u=r.getVersionsModel({reference:this._sComponentName,layer:n.CUSTOMER});h=u.getProperty("/persistedVersion");p=u.getProperty("/draftFilenames")}return this._removeOtherLayerChanges(e,a,o).then(this._oChangePersistence.saveDirtyChanges.bind(this._oChangePersistence,e,t,undefined,h,p,s,a)).then(function(e){if(i&&e&&e.response){var n=e.response;var t=[];if(Array.isArray(n)){n.forEach(function(e){t.push(e.fileName)});[n]=n}r.onAllChangesSaved({reference:n.reference,layer:n.layer,draftFilenames:t})}return e})};l.prototype.resetChanges=function(e,n,t,r,i){return this._oChangePersistence.resetChanges(e,n,r,i).then(f.bind(this,t,undefined))};l.prototype.removeDirtyChanges=function(e,n,t,r,i,a){return this._oChangePersistence.removeDirtyChanges(e,n,t,r,i).then(f.bind(this,n,a))};l.prototype.applyVariantChanges=function(n,t){var r;return n.reduce(function(e,n){return e.then(function(){var e={modifier:p,appComponent:t};this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(t,n);r=e.modifier.bySelector(n.getSelector(),t);if(r){return i.applyChangeOnControl(n,r,e)}c.error("A flexibility change tries to change a nonexistent control.");return undefined}.bind(this))}.bind(this),e.FakePromise?new e.FakePromise:Promise.resolve())};l.prototype.saveSequenceOfDirtyChanges=function(e,n){return this._oChangePersistence.saveDirtyChanges(n,false,e).then(function(n){e.forEach(function(e){e.setState(s.LifecycleState.PERSISTED)});return n})};return l});
//# sourceMappingURL=FlexController.js.map