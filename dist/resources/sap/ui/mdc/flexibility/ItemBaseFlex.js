/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/p13n/Engine","sap/base/Log","sap/ui/mdc/flexibility/Util","sap/ui/fl/changeHandler/Base","sap/ui/fl/changeHandler/condenser/Classification"],function(e,t,n,i,r){"use strict";const a={beforeAddItem:function(e,t,n,i){return e.addItem(n,t,i)},afterRemoveItem:function(e,t,n,i){return e.removeItem(n,t,i)},findItem:function(e,t,n){return Promise.resolve()},beforeApply:function(e,t,n){return},afterApply:function(e,t,n){return},determineAggregation:function(e,t){let n;return Promise.resolve().then(e.getControlMetadata.bind(e,t)).then(function(i){n=i.getDefaultAggregation().name;return e.getAggregation(t,n)}).then(function(e){return{name:n,items:e}})},_getExistingAggregationItem:function(e,t,n){const i=t.modifier;return this.determineAggregation(i,n).then(function(t){let n;const r=t.items;if(r){n=this.findItem(i,r,e.name)}return n}.bind(this))},_getDelegate:function(e){return new Promise(function(t,n){sap.ui.require([e],t,n)}).then(function(e){return e})},_getOperationText:function(e){return e?"reverted ":"applied "},_getChangeTypeText:function(e){return e?"add":"remove"},_applyAdd:function(e,t,r,a){const o=a===n.REVERT;this.beforeApply(e.getChangeType(),t,o);const g=r.modifier,s=o?e.getRevertData():e.getContent();const d=s.name;let c;let u;let f;let h;const l=this.determineAggregation(g,t).then(function(e){f=e;u=f.items;c=s.index>-1?s.index:u.length;return this._getExistingAggregationItem(s,r,t)}.bind(this)).then(function(e){if(e){return e}else{return g.getProperty(t,"delegate").then(function(e){return this._getDelegate(e.name)}.bind(this)).then(function(e){return this.beforeAddItem(e,d,t,r,s)}.bind(this)).then(function(e){return e})}}.bind(this)).then(function(e){if(!e){throw new Error("No item in"+f.name+"  created. Change to "+this._getChangeTypeText(!o)+"cannot be "+this._getOperationText(o)+"at this moment")}if(u.indexOf(e)<0){g.insertAggregation(t,f.name,e,c)}else{return i.markAsNotApplicable("The specified change is already existing - change appliance ignored",true)}h=e.getId?e.getId():e.id;return e}.bind(this)).then(function(){if(o){e.resetRevertData()}else{e.setRevertData({name:s.name,index:c,item:h})}this.afterApply(e.getChangeType(),t,o)}.bind(this));return l},_applyRemove:function(e,t,r,a){const o=a===n.REVERT;this.beforeApply(e.getChangeType(),t,o);const g=r.modifier,s=o?e.getRevertData():e.getContent();let d;let c;let u;let f;const h=this.determineAggregation(g,t).then(function(e){d=e;return this._getExistingAggregationItem(s,r,t)}.bind(this)).then(function(e){u=e;if(!u){return i.markAsNotApplicable("The specified change is already existing - change appliance ignored",true)}else{return g.findIndexInParentAggregation(u)}}).then(function(e){c=e;return g.removeAggregation(t,d.name,u)}).then(function(){return g.getProperty(t,"delegate").then(function(e){return this._getDelegate(e.name)}.bind(this)).then(function(n){return this.afterRemoveItem(n,u,t,r).then(function(n){if(n&&u){f=g.getId(u);g.destroy(u,"KeepDom")}this.afterApply(e.getChangeType(),t,o)}.bind(this))}.bind(this))}.bind(this)).then(function(){if(o){e.resetRevertData()}else{e.setRevertData({name:s.name,index:c,item:f})}});return h},_applyMove:function(e,t,r,a){let o;const g=a===n.REVERT;this.beforeApply(e.getChangeType(),t,g);if(this._bSupressFlickering){this._delayInvalidate(t)}const s=r.modifier;const d=g?e.getRevertData():e.getContent();let c;let u;let f;const h=this.determineAggregation(s,t).then(function(e){u=e;return this._getExistingAggregationItem(d,r,t)}.bind(this)).then(function(e){c=e}).then(function(){if(!c){return i.markAsNotApplicable("The specified change is already existing - change appliance ignored",true)}else{o=c.getId?c.getId():c.id;return s.findIndexInParentAggregation(c)}}).then(function(e){f=e;if(t.moveColumn){return t.moveColumn(c,d.index)}else{return s.removeAggregation(t,u.name,c).then(function(){return s.insertAggregation(t,u.name,c,d.index)})}}).then(function(){if(g){e.resetRevertData()}else{e.setRevertData({name:d.name,index:f,item:o})}this.afterApply(e.getChangeType(),t,g)}.bind(this));return h},_removeIndexFromChange:function(e){const t=e.getContent();delete t.index;e.setContent(t)},createAddChangeHandler:function(){return n.createChangeHandler({apply:this._applyAdd.bind(this),revert:this._applyRemove.bind(this),getCondenserInfo:function(e,t){const n=t.modifier.bySelector(e.getSelector(),t.appComponent);return this.determineAggregation(t.modifier,n).then(function(t){return{affectedControl:{idIsLocal:false,id:e.getRevertData().item},targetContainer:e.getSelector(),targetAggregation:t.name,classification:r.Create,setTargetIndex:function(e,t){e.getContent().index=t},getTargetIndex:function(e){return e.getContent().index}}})}.bind(this)})},createRemoveChangeHandler:function(){return n.createChangeHandler({apply:this._applyRemove.bind(this),complete:this._removeIndexFromChange.bind(this),revert:this._applyAdd.bind(this),getCondenserInfo:function(e,t){const n=t.modifier.bySelector(e.getSelector(),t.appComponent);return this.determineAggregation(t.modifier,n).then(function(t){return{affectedControl:{idIsLocal:false,id:e.getRevertData().item},targetContainer:e.getSelector(),targetAggregation:t.name,classification:r.Destroy,sourceIndex:e.getRevertData().index,setIndexInRevertData:function(e,t){const n=e.getRevertData();n.index=t;e.setRevertData(n)}}})}.bind(this)})},createMoveChangeHandler:function(){return n.createChangeHandler({apply:this._applyMove.bind(this),revert:this._applyMove.bind(this),getCondenserInfo:function(e,t){const n=t.modifier.bySelector(e.getSelector(),t.appComponent);return this.determineAggregation(t.modifier,n).then(function(t){return{affectedControl:{idIsLocal:false,id:e.getRevertData().item},targetContainer:e.getSelector(),targetAggregation:t.name,classification:r.Move,sourceIndex:e.getRevertData().index,sourceContainer:e.getSelector(),sourceAggregation:t.name,setTargetIndex:function(e,t){e.getContent().index=t},getTargetIndex:function(e){return e.getContent().index},setIndexInRevertData:function(e,t){const n=e.getRevertData();n.index=t;e.setRevertData(n)}}})}.bind(this)})}};return a});
//# sourceMappingURL=ItemBaseFlex.js.map