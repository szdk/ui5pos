/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../table/V4AnalyticsPropertyHelper","../../util/loadModules","sap/m/ColumnPopoverSelectListItem","sap/m/MessageBox","sap/m/plugins/PluginBase","sap/ui/core/Item","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/format/ListFormat","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/enums/TableP13nMode","sap/ui/mdc/enums/TableType"],function(e,t,n,r,i,o,s,a,l,u,g,c,p,f){"use strict";const d=new window.WeakMap;const T=Object.assign({},e);T.getTypeMap=function(e){return c};T.getPropertyHelperClass=function(){return t};T.preInit=function(){return Promise.resolve()};T.initializeContent=function(t){return e.initializeContent.apply(this,arguments).then(function(){if(!d.has(t)){d.set(t,{})}return B(t)}).then(function(){E(t)})};T.initializeSelection=function(t){if(t._bV4LegacySelectionEnabled){return e.initializeSelection.apply(this,arguments)}if(t._isOfType(f.Table,true)){return b(t)}else{return e.initializeSelection.apply(this,arguments)}};function b(t){const r={Single:"Single",SingleMaster:"Single",Multi:"MultiToggle"};return n("sap/ui/table/plugins/ODataV4Selection").then(function(n){const i=n[0];if(t._bV4LegacySelectionEnabled){return e.initializeSelection.call(this,t)}t._oTable.addDependent(new i({limit:"{$sap.ui.mdc.Table#type>/selectionLimit}",enableNotification:true,hideHeaderSelector:"{= !${$sap.ui.mdc.Table#type>/showHeaderSelector} }",selectionMode:{path:"$sap.ui.mdc.Table>/selectionMode",formatter:function(e){return r[e]}},enabled:{path:"$sap.ui.mdc.Table>/selectionMode",formatter:function(e){return e in r}},selectionChange:function(e){t._onSelectionChange({selectAll:e.getParameter("selectAll")})}}))})}function m(e,t){const n=o.getPlugin(e._oTable,"sap.ui.table.plugins.ODataV4Selection");if(n){return n.setSelectedContexts(t)}const r=o.getPlugin(e._oTable,"sap.ui.table.plugins.MultiSelectionPlugin");if(r){r.clearSelection();return t.map(function(e){const t=e.getIndex();return r.addSelectionInterval(t,t)})}throw Error("Unsupported operation: TableDelegate does not support #setSelectedContexts for the given Table configuration")}T.setSelectedContexts=function(t,n){if(t._isOfType(f.Table,true)){m(t,n)}else{e.setSelectedContexts.apply(this,arguments)}};T.getSelectedContexts=function(t){if(!t._oTable){return[]}if(t._bV4LegacySelectionEnabled){return e.getSelectedContexts.apply(this,arguments)}if(t._isOfType(f.Table,true)){const e=o.getPlugin(t._oTable,"sap.ui.table.plugins.ODataV4Selection");return e?e.getSelectedContexts():[]}return e.getSelectedContexts.apply(this,arguments)};T.validateState=function(t,n,r){const i=e.validateState.apply(this,arguments);let o;if(r=="Sort"){o=S(t,n)}else if(r=="Group"){o=y(t,n)}else if(r=="Column"){o=_(t,n)}return v(i,o)};function S(e,t){if(M(e)&&x(e,t.items,t.sorters)){return{validation:l.MessageType.Information,message:a.getLibraryResourceBundle("sap.ui.mdc").getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")}}return null}function y(e,t){const n=a.getLibraryResourceBundle("sap.ui.mdc");if(t.aggregations){const r=Object.keys(t.aggregations);const i=[];const o=u.getInstance();r.forEach(function(t){const n=e.getPropertyHelper().getProperty(t);if(n&&n.groupable){i.push(t)}});if(i.length>0){return{validation:l.MessageType.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_TOTALS",[o.format(i)])}}}else if(e._isOfType(f.ResponsiveTable)){if(x(e,t.items,t.groupLevels)){return{validation:l.MessageType.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}return null}function _(e,t){const n=a.getLibraryResourceBundle("sap.ui.mdc");const r=t.aggregations&&Object.keys(t.aggregations);let i;if(e._isOfType(f.ResponsiveTable)){if(x(e,t.items,t.groupLevels)){return{validation:l.MessageType.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}if(x(e,t.items,r)){i=n.getText("table.PERSONALIZATION_DIALOG_TOTAL_RESTRICTION")}if(M(e)&&x(e,t.items,t.sorters)){const e=n.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION");i=i?i+"\n"+e:e}if(i){return{validation:l.MessageType.Information,message:i}}return null}T.updateBinding=function(e,t,n,r){if(!n||n.getPath()!=t.path){this.rebind(e,t);return}const i=n.getRootBinding();let s=i&&!i.isSuspended();try{if(s){i.suspend()}E(e,t);n.changeParameters(t.parameters);n.filter(t.filters,"Application");n.sort(t.sorter);if(r&&r.forceRefresh){n.refresh()}}catch(r){this.rebind(e,t);if(i==n){s=false}}finally{if(s&&i.isSuspended()){i.resume()}}if(e._bV4LegacySelectionEnabled&&e._isOfType(f.Table)){const t=o.getPlugin(e._oTable,"sap.ui.table.plugins.MultiSelectionPlugin");const n=t?t.oInnerSelectionPlugin:null;if(n){n._bInternalTrigger=true}e.clearSelection();if(n){delete n._bInternalTrigger}}};T.rebind=function(t,n){E(t,n);e.rebind.apply(this,arguments)};T.addColumnMenuItems=function(e,t){const n=e.getPropertyHelper();const r=n.getProperty(t.getPropertyKey());const i=[];if(!r){return[]}if(e.isGroupingEnabled()){const e=r.getGroupableProperties();if(e.length>0){i.push(I(e,t))}}if(e.isAggregationEnabled()){const e=r.getAggregatableProperties().filter(function(e){return e.extension.customAggregate!=null});if(e.length>0){i.push(P(e,t))}}const o=e._oPopover;if(o){o.getItems().forEach(function(e,t,n){const r=e.getLabel();const i=a.getLibraryResourceBundle("sap.ui.mdc");if(r===i.getText("table.SETTINGS_GROUP")||r===i.getText("table.SETTINGS_TOTALS")){n[t].destroy()}if(n.length==0){o.destroy()}})}return i};T.getSupportedP13nModes=function(t){const n=e.getSupportedP13nModes.apply(this,arguments);if(t._isOfType(f.Table)){if(!n.includes(p.Group)){n.push(p.Group)}if(!n.includes(p.Aggregate)){n.push(p.Aggregate)}}return n};T.getGroupSorter=function(t){const n=t._getGroupedProperties()[0];if(!n||!t._isOfType(f.ResponsiveTable)){return undefined}if(!G(t).includes(n.name)){return undefined}return e.getGroupSorter.apply(this,arguments)};T.getSorters=function(t){let n=e.getSorters.apply(this,arguments);if(M(t)){const e=t.getPropertyHelper();const r=G(t).map(t=>e.getProperty(t).path);n=n.filter(e=>r.includes(e.sPath))}return n};T.getSupportedFeatures=function(t){const n=e.getSupportedFeatures.apply(this,arguments);const r=t._isOfType(f.TreeTable);return Object.assign(n,{expandAll:r,collapseAll:r})};T.expandAll=function(e){if(!this.getSupportedFeatures(e).expandAll){return}const t=e.getRowBinding();if(t){t.setAggregation(Object.assign(t.getAggregation(),{expandTo:999}))}};T.collapseAll=function(e){if(!this.getSupportedFeatures(e).collapseAll){return}const t=e.getRowBinding();if(t){t.setAggregation(Object.assign(t.getAggregation(),{expandTo:1}))}};function I(e,t){const n=e.map(function(e){return new s({text:e.label,key:e.name})});if(n.length>0){return new r({items:n,label:a.getLibraryResourceBundle("sap.ui.mdc").getText("table.SETTINGS_GROUP"),icon:"sap-icon://group-2",action:[{sName:"Group",oMDCColumn:t},h,this]})}}function P(e,t){const n=e.map(function(e){return new s({text:e.label,key:e.name})});if(n.length>0){return new r({items:n,label:a.getLibraryResourceBundle("sap.ui.mdc").getText("table.SETTINGS_TOTALS"),icon:"sap-icon://sum",action:[{sName:"Aggregate",oMDCColumn:t},h,this]})}}function h(e,t){const n=t.sName,r=t.oMDCColumn.getParent(),o=r.getCurrentState().groupLevels||[],s=r.getCurrentState().aggregations||{},l=Object.keys(s),u=e.getParameter("property"),g=n==="Aggregate"?o:l,c=g.filter(function(e){return n==="Aggregate"?e.name===u:e===u}).length>0;let p=false;if(c){const e=a.getLibraryResourceBundle("sap.ui.mdc");let t;let o;let s;if(n==="Aggregate"){t=e.getText("table.SETTINGS_WARNING_TITLE_TOTALS");o=e.getText("table.SETTINGS_MESSAGE2");s=e.getText("table.SETTINGS_WARNING_BUTTON_TOTALS")}else{t=e.getText("table.SETTINGS_WARNING_TITLE_GROUPS");o=e.getText("table.SETTINGS_MESSAGE1");s=e.getText("table.SETTINGS_WARNING_BUTTON_GROUP")}p=true;i.warning(o,{id:r.getId()+"-messageBox",title:t,actions:[s,e.getText("table.SETTINGS_WARNING_BUTTON_CANCEL")],onClose:function(e){if(e===s){A(n,r,u)}}})}if(n==="Aggregate"&&!p){O(n,r,u)}else if(n==="Group"&&!p){O(n,r,u)}}function O(e,t,n){if(e==="Group"){t._onCustomGroup(n)}else{t._onCustomAggregate(n)}}function A(e,t,n){if(e==="Aggregate"){t._onCustomGroup(n);t._onCustomAggregate(n)}else if(e==="Group"){t._onCustomAggregate(n);t._onCustomGroup(n)}}function E(e,t){const n=d.get(e).plugin;if(!n||n.isDestroyed()){return}const r=e._getGroupedProperties().map(function(e){return e.name});const i=Object.keys(e._getAggregatedProperties());const o=t?t.parameters["$search"]:undefined;if(o){delete t.parameters["$search"]}const s={visible:G(e),groupLevels:r,grandTotal:i,subtotals:i,columnState:N(e,i),search:o};n.setAggregationInfo(s)}function G(e){const t=new Set;e.getColumns().forEach(function(n){const r=e.getPropertyHelper().getProperty(n.getPropertyKey());if(!r){return}r.getSimpleProperties().forEach(function(e){t.add(e.name)})});return Array.from(t)}function N(e,t){const n={};e.getColumns().forEach(function(r){let i=r.getId()+"-innerColumn";const o=R(e,r,t);const s=o.length>0;if(i in n){n[i].subtotals=s||n[i].subtotals;n[i].grandTotal=s||n[i].grandTotal;return}n[i]={subtotals:s,grandTotal:s};L(e,o).forEach(function(e){i=e.getId()+"-innerColumn";if(i in n){n[i].subtotals=s||n[i].subtotals;n[i].grandTotal=s||n[i].grandTotal}else{n[i]={subtotals:s,grandTotal:s}}})});return n}function C(e,t){const n=e.getPropertyHelper().getProperty(t.getPropertyKey());if(!n){return[]}else{return n.getSimpleProperties()}}function R(e,t,n){return C(e,t).filter(function(e){return n.includes(e.name)})}function L(e,t){const n=[];t.forEach(function(e){if(e.unitProperty){n.push(e.unitProperty)}});return e.getColumns().filter(function(t){return C(e,t).some(function(e){return n.includes(e)})})}function x(e,t,n){const r=[];if(t){t.forEach(function(t){e.getPropertyHelper().getProperty(t.name).getSimpleProperties().forEach(function(e){r.push(e.name)})})}const i=n?n.every(function(e){return r.find(function(t){return e.name?e.name===t:e===t})}):true;return!i}function v(e,t){const n={Error:1,Warning:2,Information:3,None:4};if(!t||n[t.validation]-n[e.validation]>0){return e}else{return t}}function M(e){return(e.isGroupingEnabled()||e.isAggregationEnabled())&&e._isOfType(f.Table)}function B(e){if(e._isOfType(f.Table)){return(M(e)?D(e):w(e)).then(function(){return H(e)})}return Promise.resolve()}function D(e){const t=d.get(e);let r=t.plugin;if(r&&!r.isDestroyed()){r.activate();return Promise.resolve()}return Promise.all([e.awaitPropertyHelper(),n("sap/ui/table/plugins/V4Aggregation")]).then(function(n){const i=n[1][0];const o=e.getControlDelegate();r=new i({groupHeaderFormatter:function(t,n){return o.formatGroupHeader(e,t,n)}});r.setPropertyInfos(e.getPropertyHelper().getPropertiesForPlugin());e.propertiesFinalized().then(function(){r.setPropertyInfos(e.getPropertyHelper().getPropertiesForPlugin())});e._oTable.addDependent(r);t.plugin=r})}function w(e){const t=d.get(e);if(t.plugin){t.plugin.deactivate()}return Promise.resolve()}function H(e){const t=d.get(e);if(!t.observer){t.observer=new g(function(t){B(e)});t.observer.observe(e,{properties:["p13nMode"]})}}return T});
//# sourceMappingURL=TableDelegate.js.map