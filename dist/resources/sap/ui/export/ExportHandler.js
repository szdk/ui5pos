/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["./library","./ExportUtils","./ExportDialog","./util/PDFCapabilities","sap/m/MessageToast","sap/ui/core/Core","sap/ui/base/EventProvider","sap/ui/model/odata/v4/ODataModel","sap/ui/util/openWindow"],function(e,t,i,r,n,o,a,l,s){"use strict";var u=e.Destination;var h=e.FileType;var p=a.extend("sap.ui.export.ExportHandler",{constructor:function(e){var t=this;a.call(this);this._mCapabilities=e instanceof Object?e:{XLSX:{}};if(this._mCapabilities.PDF){var i=this._mCapabilities.PDF;if(typeof i.isA!=="function"||!i.isA("sap.ui.export.util.PDFCapabilities")){this._mCapabilities.PDF=new r(i)}if(!this._mCapabilities.PDF.isValid()){delete this._mCapabilities.PDF}}this._initialized=new Promise(function(e){t.isGoogleSheetSupported().then(function(e){if(e){t._mCapabilities[h.GSHEET]={};t._mDialogSettings={destination:u.REMOTE,fileType:h.GSHEET}}}).finally(e)})}});p.prototype.attachBeforeExport=function(e,t,i){return this.attachEvent("beforeExport",e,t,i)};p.prototype.detachBeforeExport=function(e,t){return this.detachEvent("beforeExport",e,t)};p.prototype.initialized=function(){return this._initialized};p.prototype.destroy=function(){a.prototype.destroy.apply(this,arguments);if(this._oModel){this._oModel.destroy()}if(this._oFileShareBinding){this._oFileShareBinding.destroy()}if(this._oExportDialog){this._oExportDialog.destroy()}if(this._oFilePicker){this._oFilePicker.destroy()}this._mCapabilities=null;this._oDataSource=null;this._mDialogSettings=null;this._oModel=null;this._oFileShareBinding=null;this.bIsDestroyed=true};p.prototype.getFileShareContexts=function(){return this.getFileShareModel().then(function(e){if(!e){return Promise.resolve([])}if(!this._oFileShareBinding){this._oFileShareBinding=e.bindList("/FileShares")}return this._oFileShareBinding.requestContexts(0)}.bind(this))};p.prototype.getRemoteFileLocation=function(e){var i=this;return new Promise(function(r,n){Promise.all([t.getResourceBundle(),i.getFileShareModel()]).then(function(t){var o=t[0];var a=t[1];sap.ui.require(["sap/suite/ui/commons/CloudFilePicker"],function(t){var l;i._oFilePicker=l=new t({sharedModel:a,suggestedFileName:e,enableDuplicateCheck:true,fileNameMandatory:true,confirmButtonText:o.getText("EXPORT_BUTTON"),title:o.getText("DESTINATION_DIALOG_TITLE")});l.attachSelect(function(e){var t,i,a,l={};t=e.getParameter("selectedFiles");i=e.getParameter("selectedFolder");a=e.getParameter("replaceExistingFile");l={};l["FileShare"]=i.getFileShareId();l["FileShareItemKind"]="document";l["FileShareItemName"]=e.getParameter("selectedFileName");l["ParentFileShareItem"]=i.getFileShareItemId();if(a&&Array.isArray(t)&&t.length>0){var s=t.shift();l["FileShareItem"]=s.getFileShareItemId()}if(!l["FileShare"]){n(o.getText("DESTINATION_SELECTION_INCOMPLETE"))}r(l)});l.open()})})})};p.prototype.getExportInstance=function(e,r,o){var a=this;return Promise.all([t.getResourceBundle(),t.getExportInstance(e,this._mCapabilities)]).then(function(l){var s=l[0];var u=l[1];var p=[];var c;if(r&&r.includeFilterSettings){var f=e.workbook.context;if(!f){f=e.workbook.context={metainfo:[]}}c={name:s.getText("FILTER_HEADER"),items:[]};p=r.includeFilterSettings?t.getFilters(e.dataSource):[];f.metaSheetName=c.name;f.metainfo.push(c)}u.attachBeforeExport(function(e){var t=e.getParameter("exportSettings");a.fireEvent("beforeExport",{exportSettings:t,userExportSettings:r||{},filterSettings:p},false,false);p.filter(function(e){return e&&typeof e.isA==="function"&&e.isA("sap.ui.export.util.Filter")}).sort(function(e,t){var i=e.getLabel().toLowerCase();var r=t.getLabel().toLowerCase();if(i>r){return 1}if(i<r){return-1}return 0}).forEach(function(e){c.items.push({key:e.getLabel(),value:e.getValue()})})});if(o&&typeof u.attachBeforeSave==="function"){u.attachBeforeSave(function(t){var r,l;r=t.getParameter("data");l=t.getParameter("exportDialog");o["FileShareItemContentType"]=u.getMimeType();o["FileShareItemConvertToMimeType"]=u.getMimeType();if(e.fileType===h.GSHEET){o["FileShareItemConvertToMimeType"]="application/vnd.google-apps.spreadsheet"}var p=new Uint8Array(r);var c=new Array(p.length);for(var f=0;f<p.length;f++){c[f]=String.fromCharCode(p[f])}o["FileShareItemContent"]=btoa(c.join(""));l.updateStatus(s.getText("DESTINATION_DIALOG_STATUS"));t.preventDefault();a.uploadFile(o).then(function(){n.show(s.getText("DESTINATION_TRANSFER_SUCCESS"))}).catch(function(){i.showErrorMessage(s.getText("DESTINATION_TRANSFER_ERROR"))}).finally(function(){l.finish()})})}return u})};p.prototype.uploadFile=function(e){return this.getFileShareModel().then(function(t){var i,r,n,o,a;n="FileShareItemContent";o="FileShareItemContentType";if(e["FileShareItem"]){r=t.getKeepAliveContext("/FileShareItems(FileShare='"+e.FileShare+"',FileShareItem='"+e.FileShareItem+"')");r.setProperty("FileShareItemContentLink","",null);r.setProperty(o,e[o]);return r.setProperty(n,e[n]).then(function(){return r.getProperty("FileShareItemContentLink")})}if(e.ParentFileShareItem){a="/FileShareItems(FileShare='"+e.FileShare+"',FileShareItem='"+e.ParentFileShareItem+"')/_Children"}else{a="/FileShares(FileShare='"+e.FileShare+"')/_Root/_Children"}i=t.bindList(a);return this._createFile(i,e)}.bind(this)).then(function(e){if(e){s(e)}})};p.prototype._createFile=function(e,t){return new Promise(function(i,r){function n(t){var o,a;o=t.getParameter("success");a=t.getParameter("context");if(o){e.detachCreateCompleted(n);i(a.getProperty("FileShareItemContentLink"))}else{a.destroy();r()}}e.attachCreateCompleted(n);e.create(t,true)})};p.prototype.export=function(e){if(this.bIsDestroyed){Promise.reject("ExportHandler must not be used after calling #destroy")}return this.getExportInstance(e).then(function(e){return e.build().finally(function(){e.destroy()})})};p.prototype.exportAs=function(e,r){var n=this;var o;var a={};if(this.bIsDestroyed){return Promise.reject("ExportHandler must not be used after calling #destroy")}return this.initialized().then(function(){o=Object.assign({},e,n._mDialogSettings);return n.getFileShareContexts()}).then(function(e){return t.getExportSettingsViaDialog(o,n._mCapabilities,e.length>0,function(e){n._oExportDialog=e})}).then(function(e){n._mDialogSettings=e;Object.assign(o,e);t.validateFileSettings(o);a.splitCells=e.splitCells;a.includeFilterSettings=e.includeFilterSettings;if(o.fileType===h.PDF||e.splitCells){o.workbook.columns=t.splitColumns(o.workbook.columns,r)}if(o.includeFilterSettings){return t.parseTechnicalConfiguration()}return Promise.resolve()}).then(function(e){if(e){var t=o.workbook.context;if(!t){t=o.workbook.context={}}t.metainfo=Array.isArray(t.metainfo)?t.metainfo.push(e):[e]}}).then(function(){if(o.destination===u.LOCAL){return Promise.resolve()}return n.getRemoteFileLocation(o.fileName)}).then(function(e){if(e&&!e["FileShareItem"]){e.FileShareItemName=t.validateFileName(e.FileShareItemName,o.fileType)}if(o.fileType===h.GSHEET){return n.validateFileShare(e)}return e}).then(function(e){return n.getExportInstance(o,a,e).then(function(e){return e.build().finally(function(){e.destroy()})})}).catch(i.showErrorMessage)};p.prototype.validateFileShare=function(e){return Promise.all([t.getResourceBundle(),this.getFileShareContexts()]).then(function(t){var i=t[0];var r=t[1];var n=r.find(function(t){return t.getProperty("FileShare")===e.FileShare});return this.isGoogleWorkspace(n)?e:Promise.reject(i.getText("DESTINATION_ERROR_NOT_GOOGLE"))}.bind(this))};p.prototype.getFileShareModel=function(){if(this._oModel){return Promise.resolve(this._oModel)}return t.fetchDataSource().then(function(e){if(e){this._oModel=new l({serviceUrl:e.uri,synchronizationMode:"None",autoExpandSelect:true})}return this._oModel}.bind(this))};p.prototype.isGoogleSheetSupported=function(){return this.getFileShareContexts().then(function(e){return e.some(this.isGoogleWorkspace)}.bind(this))};p.prototype.isGoogleWorkspace=function(e){var t,i;i=e.getProperty("FileShareVendorType");t=e.getProperty("FileShareDescription");return i==="GOOGLE"||typeof t==="string"&&t.indexOf("Google")>-1};return p},true);
//# sourceMappingURL=ExportHandler.js.map