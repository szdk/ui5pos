/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
(function(e){"use strict";if(typeof sap!=="undefined"&&typeof sap.ui.define==="function"){sap.ui.define([],e,true)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof self!=="undefined"){t=self}else{t=this}t.DataProviderBase=e()}})(function(){"use strict";var e=function(t){this.mSettings=t;this.bCanceled=false;this.iAvailableRows=0;this.mRequest=null;this.iTotalRows=Math.min(t.dataSource.count||e.MAX_ROWS,e.MAX_ROWS);this.iBatchSize=Math.min(t.dataSource.sizeLimit||e.MAX_ROWS,this.iTotalRows);this._prepareDataUrl()};e.MAX_ROWS=1048575;e.HTTP_ERROR_MSG="HTTP connection error";e.HTTP_WRONG_RESPONSE_MSG="Unexpected server response:\n";e._createGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,r=e==="x"?t:t&3|8;return r.toString(16)})};e.getColumnsToConvert=function(e){return e.reduce(function(e,t){var r;r=t.property instanceof Array?t.property:[t.property];if(t.unitProperty){r.push(t.unitProperty)}r.forEach(function(t){var r=t.split("/");if(r.length>1){e.push({property:t,keys:r})}});return e},[])};e.getDataConverter=function(t){var r,n;r=t.workbook.columns;if(t.workbook.hierarchyLevel){r=r.concat([{property:t.workbook.hierarchyLevel}])}n=this.getColumnsToConvert(r);return function(t){return e._convertData(t,n)}};e._convertData=function(t,r){r.forEach(function(r){t.forEach(function(t){t[r.property]=e._getValue(t,r)})});return t};e._getValue=function(e,t){var r=t.keys.reduce(function(e,t){return e&&e[t]},e);return r};e.prototype.requestData=function(t){var r=this.mSettings.dataSource;this.fnConvertData=e.getDataConverter(this.mSettings);this.fnProcessCallback=t;this.mRequest={serviceUrl:this._cleanUrl(r.serviceUrl),dataUrl:this._getUrl(0,this.iBatchSize),method:r.useBatch?"BATCH":"GET",headers:r.headers};this.sendRequest(this.mRequest).then(this.fnOnDataReceived.bind(this)).catch(this.fnOnError.bind(this));return{cancel:function(){this.bCanceled=true;if(this.oPendingXHR instanceof XMLHttpRequest){this.oPendingXHR.abort()}}.bind(this)}};e.prototype.fnOnDataReceived=function(e){var t,r,n,i;var s={};this.oPendingXHR=null;if(this.bCanceled){return}t=e&&e.value||e.d&&(e.d.results||e.d)||e;t=Array.isArray(t)?t:[];n=t.length;this.iAvailableRows+=n;i=this.iTotalRows-this.iAvailableRows;s.finished=n===0||i<=0;s.progress=this.iTotalRows;s.total=this.iTotalRows;s.fetched=this.iAvailableRows;r=e&&e["@odata.nextLink"]||e.d&&e.d.__next||null;if(!s.finished){this.mRequest.dataUrl=this._getUrl(this.iAvailableRows,Math.min(this.iBatchSize,i),r);this.sendRequest(this.mRequest).then(this.fnOnDataReceived.bind(this)).catch(this.fnOnError.bind(this))}s.rows=this.fnConvertData(t);this.fnProcessCallback(s)};e.prototype.fnOnError=function(e){this.fnProcessCallback({error:e})};e.prototype._cleanUrl=function(e){var t;if(!e){return""}t=new URL(e);t.hash=t.search="";t.pathname+=t.pathname.endsWith("/")?"":"/";return t.toString()};e.prototype._prepareDataUrl=function(){var e=this.mSettings.dataSource;var t,r=/\$skip\=[0-9]+/,n=/\$top\=[0-9]+/;if(!e.dataUrl){throw"Unable to load data - no URL provided."}t=new URL(e.dataUrl);t.search=t.search||"";if(!r.test(t.search)){t.search+=(t.search.length?"&$skip=":"$skip=")+0}if(!n.test(t.search)){t.search+="&$top="+0}this.mSettings.dataSource.dataUrl=t.toString()};e.prototype._getUrl=function(e,t,r){var n,i;n=new URL(this.mSettings.dataSource.dataUrl);if(r){i=new URL(r,n.origin);n.search=i.search}else{n.search=(n.search||"").replace(/\$skip\=[0-9]+/g,"$skip="+e).replace(/\$top\=[0-9]+/g,"$top="+t)}return n.toString()};e.prototype.sendRequest=function(e){var t;if(typeof e!=="object"||e===null||typeof e.dataUrl!=="string"){throw new Error("Unable to send request - Mandatory parameters missing.")}t=(e.method==="BATCH"&&e.serviceUrl?this.sendBatchRequest:this.sendGetRequest).bind(this);return t(e)};e.prototype.sendBatchRequest=function(t){return new Promise(function(r,n){var i=new XMLHttpRequest;var s="batch_"+e._createGuid();var a=t.dataUrl.split(t.serviceUrl)[1];var o=[];var h,c;i.onload=function(){var t,i,s,a,o,h,c;i=this.responseText.split("\r\n");o=0;a=i.length;s=a-1;i.forEach(function(e){c=e.match(/^HTTP\/1\.[0|1] ([1-9][0-9]{2})/);if(Array.isArray(c)&&c[1]){h=c[1]}});while(o<a&&i[o].slice(0,1)!=="{"){o++}while(s>0&&i[s].slice(-1)!=="}"){s--}i=i.slice(o,s+1);t=i.join("\r\n");if(h&&parseInt(h)>=400){n(e.HTTP_WRONG_RESPONSE_MSG+t);return}try{r(JSON.parse(t))}catch(r){n(e.HTTP_WRONG_RESPONSE_MSG+t)}};i.onerror=function(){n(this.responseText||e.HTTP_ERROR_MSG)};i.open("POST",t.serviceUrl+"$batch",true);i.setRequestHeader("Accept","multipart/mixed");i.setRequestHeader("Content-Type","multipart/mixed;boundary="+s);o.push("--"+s);o.push("Content-Type: application/http");o.push("Content-Transfer-Encoding: binary");o.push("");o.push("GET "+a+" HTTP/1.1");o.push("Accept:application/json");for(h in t.headers){c=t.headers[h];if(h.toLowerCase()!="accept"){i.setRequestHeader(h,c);o.push(h+":"+c)}}o.push("");o.push("");o.push("--"+s+"--");o.push("");o=o.join("\r\n");i.send(o);this.oPendingXHR=i}.bind(this))};e.prototype.sendGetRequest=function(t){return new Promise(function(r,n){var i;var s=new XMLHttpRequest;s.onload=function(){if(this.status>=400){n(this.responseText||this.statusText||e.HTTP_ERROR_MSG);return}try{r(JSON.parse(this.responseText))}catch(t){n(e.HTTP_WRONG_RESPONSE_MSG+this.responseText)}};s.onerror=function(){n(this.responseText||e.HTTP_ERROR_MSG)};s.open("GET",t.dataUrl,true);s.setRequestHeader("accept","application/json");for(i in t.headers){if(i.toLowerCase()!=="accept"){s.setRequestHeader(i,t.headers[i])}}s.send();this.oPendingXHR=s}.bind(this))};return e});
//# sourceMappingURL=DataProviderBase.js.map