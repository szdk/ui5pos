/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["./library","./util/Filter","sap/base/config","sap/base/Log","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/format/DateFormat","sap/ui/core/library","sap/ui/core/syncStyleClass","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/performance/trace/FESRHelper","sap/ui/util/openWindow","sap/ui/VersionInfo"],function(e,t,r,a,n,i,o,l,s,u,f,p,c,d,g){"use strict";var y=l.ValueState;var m=l.CalendarType;var v=e.FileType;var h=e.EdmType;var S=e.Destination;var b=null;var T=null;var E;var P="sap.ui.export.ExportUtils";var w=/[\\\/\?\*:\[\]]/g;g.load().then(function(e){var t=/^[0-9]+\.[0-9]+/.exec(e.version);b=t?t[0]:null});n.attachLocalizationChanged(function(){T=null});function A(e,t,r,a){var n=Object.keys(r);var i={fileName:"Standard",fileTypeCollection:[],fileType:"XLSX",destinationCollection:[{key:S.LOCAL,text:t.getText("DESTINATION_LOCAL")}],destination:S.LOCAL,paperSize:"DIN_A4",orientation:"LANDSCAPE",splitCells:false,includeFilterSettings:false,addDateTime:false,doEnableAccessibility:false,pdfArchive:false,capabilities:r,fitToPage:false,paperSizeCollection:[{key:"DIN_A4",text:t.getText("PAPER_SIZE_A4")},{key:"US_LETTER",text:t.getText("PAPER_SIZE_US_LETTER")}],orientationCollection:[{key:"LANDSCAPE",text:t.getText("ORIENTATION_LAND")},{key:"PORTRAIT",text:t.getText("ORIENTATION_PORT")}],fontSize:10,signature:false,signatureReason:"",showPageNumber:true};n.forEach(function(e){var r,a;r=e.toUpperCase();a=r+"_FILETYPE";i.fileTypeCollection.push({key:r,text:t.getText(a)})});if(a){i.destinationCollection.push({key:"REMOTE",text:t.getText("DESTINATION_REMOTE")})}var o=Object.assign({},i,e||{});if(!o.fileTypeCollection.some(function(e){return e.key===o.fileType})){o.fileType=o.fileTypeCollection[0].key}return o}function _(e){var t={};["fileName","fileType","paperSize","orientation","splitCells","includeFilterSettings","addDateTime","doEnableAccessibility","fitToPage","fontSize","signature","signatureReason","pdfArchive","destination","showPageNumber"].forEach(function(r){t[r]=e[r]});return t}var C={_INTERCEPTSERVICE:"sap/ushell/cloudServices/interceptor/InterceptService",interceptUrl:function(e){var t=sap.ui.require(C._INTERCEPTSERVICE);if(t){var r=t.getInstance();if(r&&r.interceptUrl){e=r.interceptUrl(e)}}return e},fetchDataSource:function(){var e;if(C._oDataSource){return Promise.resolve(C._oDataSource)}e=r.get({name:"sapUiFileShareSupport",type:r.Type.String,defaultValue:undefined});if(!e){return Promise.resolve()}return new Promise(function(t){sap.ui.require([e],function(e){e.getDataSource().then(function(e){C._oDataSource=e;t(e)}).catch(function(){t()})})})},normalizeUrl:function(e){return e?new URL(e,document.baseURI).toString():e},getExportSettingsViaDialog:function(e,t,r,a,o){return new Promise(function(l,u){var d;if(typeof r==="object"){o=a;a=r;r=undefined}else if(typeof r==="function"){o=r;r=undefined}else if(typeof a==="function"){o=a;a=null}C.getResourceBundle().then(function(g){var m=new f;var h=function(e,t){var r="OI:EXP:";var a=e.getProperty("/destination");var n=e.getProperty("/fileType");r+=a===S.REMOTE?"CL:":"LOC:";switch(n){case v.PDF:r+="PDF";break;case v.XLSX:r+="XLS";break;case v.GSHEET:r+="GS";break;default:r="OI:EXP"}c.setSemanticStepname(t,"press",r)};m.setData(A(e,g,t,r));i.load({name:"sap.ui.export.fragments.SettingsDialog",type:"XML",controller:{isPDF:function(e,t){return e===v.PDF&&t!==false},isSpreadsheet:function(e){return e===v.XLSX||e===v.GSHEET},isDestinationEnabled:function(e){return e===v.XLSX},hasDestinations:function(e){return e.length>1},formatExportButton:function(e){return e===S.LOCAL?g.getText("EXPORT_BUTTON"):g.getText("DIALOG_BUTTON_CLOUD_DESTINATION")},onCancel:function(){d._bSuccess=false;d.close()},onExport:function(){d._bSuccess=true;d.close()},onFileNameChange:function(e){var t=e.getSource();var r=e.getParameter("value");var a=/[\\/:|?"*<>]/;var i=n.byId("exportSettingsDialog-exportButton");var o=a.test(r);if(o){t.setValueState(y.Error);t.setValueStateText(g.getText("FILENAME_ERROR"))}else if(r.length>100){t.setValueState(y.Warning);t.setValueStateText(g.getText("FILENAME_WARNING"))}else{t.setValueState(y.None);t.setValueStateText(null)}i.setEnabled(!o)},onFileTypeChange:function(e){var t=e.getParameter("selectedItem");if(!t){return}switch(t.getKey()){case v.PDF:m.setProperty("/includeFilterSettings",false);m.setProperty("/destination",S.LOCAL);h(m,d.getBeginButton());break;case v.GSHEET:m.setProperty("/destination",S.REMOTE);h(m,d.getBeginButton());break;default:n.byId("exportSettingsDialog-signatureReason").setVisible(false);n.byId("exportSettingsDialog-signatureReasonLabel").setVisible(false);h(m,d.getBeginButton())}},onDestinationChange:function(e){if(!e.getParameter("selectedItem")){return}h(m,d.getBeginButton())},onFontSizeChange:function(e){var t=e.getSource();var r=e.getParameter("value");var a=/[^\d]/g;var i=n.byId("exportSettingsDialog-exportButton");var o=a.test(r);if(o){t.setValueState(y.Error);t.setValueStateText(g.getText("NUMBER_ERROR"))}else{t.setValueState(y.None);t.setValueStateText(null)}i.setEnabled(!o)},onAfterClose:function(){if(d._bSuccess){l(_(m.getData()))}else{u(null)}d.destroy();d=null}}}).then(function(e){d=e;if(t.PDF&&!t.PDF["HeaderFooter"]){m.oData.showPageNumber=false}d.setModel(m);d.setModel(new p({bundle:g}),"i18n");if(a){s("sapUiSizeCompact",a,d)}h(m,d.getBeginButton());c.setSemanticStepname(d.getEndButton(),"press","OI:EXP:CANCEL");d.open();if(o){o(d)}})})})},_getReadableFilterValue:function(e){switch(e.op||e.name){case"==":case">":case"<":case"!=":case"<=":case">=":return{operator:e.op||e.name,value:e.right.value};case"between":return{operator:e.op||e.name,value:[e.args[1].value,e.args[2].value]};case"contains":case"endswith":case"startswith":return{operator:e.op||e.name,value:e.args[1].value};default:throw Error("getReadableFilter")}},_parseFilter:function(e){switch(e.type){case"Logical":return C._parseLogical(e);case"Binary":return C._parseBinary(e);case"Unary":return C._parseUnary(e);case"Call":return C._parseCall(e);default:throw Error("Filter type "+e.type+" not supported")}},_parseLogical:function(e){var t,r;try{if(e.op=="&&"&&e.left.type==="Binary"&&e.right.type==="Binary"&&e.left.op===">="&&e.right.op==="<="&&e.left.left.path===e.right.left.path){return C._parseCall({args:[{path:e.left.left.path,type:"Reference"},{type:"Literal",value:e.left.right.value},{type:"Literal",value:e.right.right.value}],name:"between",type:"Call"})}t=C._parseFilter(e.left).concat(C._parseFilter(e.right));if(e.op==="||"&&t.length){r=t[0].key;if(t.every(function(e){return e.key===r})){t=[{key:r,value:t.reduce(function(e,t){if(Array.isArray(t.value)){return e.concat(t.value)}e.push(t.value);return e},[])}]}}}catch(e){t=[]}return t},_parseBinary:function(e){if(!e.left||e.left.type!="Reference"||!e.right||e.right.type!="Literal"){return[]}return[{key:e.left.path,value:C._getReadableFilterValue(e)}]},_parseUnary:function(e){var t;if(!e.arg){return[]}t=C._parseFilter(e.arg);if(e.op==="!"&&t[0].value){t[0].value.exclude=true}return t},_parseCall:function(e){if(!e.args||e.args.length<2){return[]}return[{key:e.args[0].path,value:C._getReadableFilterValue(e)}]},parseFilterConfiguration:function(){a.error("Function is deprecated and must not be used anymore");return C.getResourceBundle().then(function(e){return{name:e.getText("FILTER_HEADER"),items:[]}})},getFilters:function(e){var r,n;r=[];if(!e||!e.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){a.error("A ListBinding or TreeBinding is required for parsing the filter settings");return r}n=e.getFilterInfo();if(n){C._parseFilter(n).forEach(function(e){r.push(new t(e.key,e.value))})}return r},parseTechnicalConfiguration:function(){var e,t,r;e={};r=sap.ushell&&sap.ushell.Container;return C.getResourceBundle().then(function(r){t=r;e.name=t.getText("TECHNICAL_INFORMATION");e.items=[{key:t.getText("CREATED_TIME"),value:o.getDateTimeWithTimezoneInstance().format(new Date)}]}).then(function(){return r&&typeof r.getServiceAsync==="function"?r.getServiceAsync("UserInfo"):undefined}).then(function(r){if(r&&r.getFullName()){e.items.unshift({key:t.getText("USER_NAME"),value:r.getFullName()})}return e})},saveAsFile:function(e,t){var r,a,n;if(!(e instanceof Blob)){return}r=document.createElementNS("http://www.w3.org/1999/xhtml","a");a="download"in r;if(a){n=function(e,t){r.download=t;r.href=URL.createObjectURL(e);r.dispatchEvent(new MouseEvent("click"))}}if(typeof n==="undefined"){n=function(e){var t=new FileReader;t.onloadend=function(){var e,r;r=t.result.replace(/^data:[^;]*;/,"data:attachment/file;");e=d(r,"_blank");if(!e){window.location.href=r}};t.readAsDataURL(e)}}n(e,t)},validateSettings:function(e){C._validateDataSource(e.dataSource);C.validateFileSettings(e);if(typeof e.showProgress!=="boolean"){e.showProgress=true}C._validateWorkbook(e.workbook);if(typeof e.worker!=="boolean"){e.worker=true}C._validateScaleCustomizing(e.customizing,"currency");C._validateScaleCustomizing(e.customizing,"unit")},validateFileSettings:function(e){e.fileType=v[e.fileType]?e.fileType:v.XLSX;e.fileName=C.validateFileName(e.fileName,e.fileType)},validateFileName:function(e,t){var r;e=e||"export";r="."+t.toLowerCase();if(!e.endsWith(r)&&t!==v.GSHEET){e+=r;a.info(P+": fileName was missing the proper file extension - extension has been added")}return e},_validateDataSource:function(e){var t;if(!e||typeof e!=="object"){throw new Error(P+": dataSource has not been specified")}e.type=typeof e.type==="string"&&e.type.toLowerCase()||"odata";if(e.type==="array"&&!Array.isArray(e.data)){a.warning(P+": Defined type does not match the provided data")}if(Array.isArray(e.data)){e.count=e.data.length}if(e.type==="odata"){if(typeof e.dataUrl!=="string"||e.dataUrl.length===0){throw new Error(P+": Unable to export data. No dataUrl provided.")}if(e.dataUrl){e.dataUrl=C.normalizeUrl(e.dataUrl)}if(e.serviceUrl){e.serviceUrl=C.normalizeUrl(e.serviceUrl)}}if(typeof e.count!=="number"||e.count<0||isNaN(e.count)||e.count%1!==0){a.info(P+": Invalid value for dataSource.count - value will be ignored");e.count=null}if(typeof e.useBatch!=="boolean"){e.useBatch=false;a.info(P+': Parameter useBatch not provided. Applying default value "false"')}else if(e.useBatch===true){if(typeof e.serviceUrl!=="string"||e.serviceUrl.length===0){e.useBatch=false;a.warning(P+": serviceUrl is required for OData batch requests")}if(typeof e.headers!=="object"){e.useBatch=false;a.warning(P+": headers are required for OData batch requests.")}}t=e.sizeLimit;if(!t||isNaN(t)||t%1!==0){var r=5e3,n=200;t=e.count?Math.round(e.count/(n*5))*n:n;t=Math.min(r,Math.max(t,n));e.sizeLimit=t;a.info(P+": No valid sizeLimit provided. sizeLimit is set to "+t)}},_validateWorkbook:function(e){if(!(e instanceof Object)||!Array.isArray(e.columns)){throw new Error(P+"column configuration is not provided. Export is not possible")}e.columns=e.columns.filter(function(e,t){var r;if(!(e instanceof Object)){a.error(P+": Column "+t+" skipped due to invalid configuration");return false}if(Array.isArray(e.property)&&e.type!==h.String&&e.type!=null){a.warning(P+": Type "+e.type+" does not support an array of properties");e.property=e.property[0]}if(typeof e.property!=="string"&&!Array.isArray(e.property)){a.error(P+": Column "+t+" skipped due to missing mandatory property");return false}e.label=e.label||(e.property instanceof Array?e.property[0]:e.property);r=e.width;if(typeof r==="string"){var i;i=r.toLowerCase();r=parseFloat(i);if(i.indexOf("em")>0){r=Math.floor((r*16-5)/8*100+.5)/100}else if(i.indexOf("px")>0){r=Math.floor((r-5)/8*100+.5)/100}}if(isNaN(r)||r<1){r=10}e.width=Math.round(r);C._validateType(e,t);C._validateString(e,"textAlign");if(e.textAlign){var o=(e.textAlign+"").toLowerCase();if(["begin","end"].indexOf(o)>-1){var l=["left","right"];o=(n.getConfiguration().getRTL()?l.reverse():l)[["begin","end"].indexOf(o)]}if(o!==""&&["left","right","center"].indexOf(o)==-1){a.warning(P+": Incorrect column alignment value "+o+' on column "'+(e.label||e.property)+'". Default alignment is used.');o=""}e.textAlign=o}["autoScale","delimiter","displayTimezone","displayUnit","utc","wrap"].forEach(function(t){C._validateProperty(e,t,"boolean")});["inputFormat","unit","unitProperty","template","trueValue","falseValue","timezone","timezoneProperty"].forEach(function(t){C._validateString(e,t)});if(e.template&&!Array.isArray(e.property)&&typeof e.inputFormat!=="string"){a.warning(P+': Template is not applicable on a single property without inputFormat - value will be discarded on column "'+(e.label||e.property)+'".');delete e.template}if(typeof e.calendar==="string"&&[m.Gregorian,m.Islamic,m.Japanese].indexOf(e.calendar)<0){a.warning(P+': Unsupported calendar "'+e.calendar+'" on column "'+(e.label||e.property)+'". Value will be discarded.');delete e.calendar}if(e.type===h.Boolean&&(e.trueValue===null||e.falseValue===null)){a.warning(P+': The properties trueValue and falseValue have to be assigned correctly on column "'+(e.label||e.property)+'". Values will be discarded.');delete e.trueValue;delete e.falseValue}if(e.autoScale===true&&(e.type!==h.Number||!e.unit&&!e.unitProperty)){a.warning(P+": autoScale cannot be taken into account due to invalid configuration.");delete e.autoScale}if(e.type===h.DateTime){if(!e.timezone){e.timezone=e.utc===false?n.getConfiguration().getTimezone():"UTC"}if(e.property===e.timezoneProperty||typeof e.timezoneProperty==="string"&&e.timezoneProperty.split(",").length>1){a.warning(P+": Property timezoneProperty is invalid.");delete e.timezoneProperty}}else if(typeof e.utc==="boolean"){a.warning(P+": Property utc is only supported for type DateTime.");delete e.utc}var s=e.scale;if(e.type===h.Number&&isNaN(s)&&s!=="variable"){a.warning(P+": scale parameter for numerical column configuration is missing.")}if(typeof s==="string"){s=parseInt(s)}if(isNaN(s)){s=null}e.scale=s;if(e.valueMap&&typeof e.valueMap!=="object"){a.warning(P+': Invalid value for property "valueMap" on column "'+(e.label||e.property)+'". Value will be discarded.');delete e.valueMap}return true});C._validateWorkbookContext(e.context);C._validateString(e,"hierarchyLevel");C._validateString(e,"drillState")},_validateType:function(e){var t,r;if(typeof e.type!=="string"){e.type=h.String;return}if(!h[e.type]){r=h.String;for(t in h){if(t.toLowerCase()==e.type.toLowerCase()){r=t}}a.warning(P+": Unsupported column type "+e.type+' on column "'+(e.label||e.property)+'". EdmType.'+r+" is applied.");e.type=r}switch(e.type){case h.Date:if(!e.format&&!e.calendar){C._validateString(e,"format",C.getFormatSettings().datePattern);C._validateString(e,"calendar",C.getFormatSettings().calendar)}break;case h.DateTime:if(!e.format&&!e.calendar){C._validateString(e,"format",C.getFormatSettings().dateTimePattern);C._validateString(e,"calendar",C.getFormatSettings().calendar)}break;case h.Time:C._validateString(e,"format",C.getFormatSettings().timePattern);break;case h.Number:break;case h.Currency:if(!e.unitProperty){a.warning(P+': Missing unitProperty for type Currency on column "'+(e.label||e.property)+'". Type is reverted to "String".');e.type=h.String}break;case h.Enumeration:if(!e.valueMap||typeof e.valueMap!=="object"){a.warning(P+': Invalid valueMap for type Enumeration on column "'+(e.label||e.property)+'". Type is reverted to "String".');e.type=h.String}break;default:}},_validateWorkbookContext:function(e){if(!(e instanceof Object)){return}C._validateString(e,"application","SAP UI5");C._validateString(e,"version",b);C._validateString(e,"title");C._validateString(e,"modifiedBy");C._validateString(e,"sheetName","SAPUI5 Spreadsheet Export",31,w);C._validateString(e,"metaSheetName","Metadata",31,w);if(e.metainfo){if(!Array.isArray(e.metainfo)){a.warning(P+': Invalid value for property "metainfo". Value will be discarded.');e.metainfo=null}else{e.metainfo.filter(function(e,t){if(typeof e.name!=="string"||e.name.length===0){a.warning(P+": Invalid name for metainfo group at index "+t+". Entry will be discarded.");return false}return true})}}},_validateString:function(e,t,r,n,i){var o;C._validateProperty(e,t,"string",r);o=e[t];if(typeof o==="string"&&(typeof i==="string"||i instanceof RegExp)){o=o.replace(i,"")}if(typeof o==="string"&&n&&o.length>n){a.warning(P+": The value of "+t+" exceeds the max length of "+n+" and will be truncated.");o=o.slice(0,n)}e[t]=o},_validateProperty:function(e,t,r,n){var i=e[t];if(i!=null&&typeof i!==r){a.warning(P+': Invalid value for property "'+t+". Value will be discarded.");i=null}if(i==null&&typeof n!=="undefined"){i=n}if(i==null){delete e[t]}else{e[t]=i}},_validateScaleCustomizing:function(e,t){var r,n;if(!e){return}n=e[t];if(!(n instanceof Object)||Array.isArray(n)){a.warning(P+": Invalid scale customizing for "+t+".");e[t]={}}else{for(r in n){if(!(n[r]instanceof Object)){a.warning(P+": Key "+r+" has been removed from customizing.");delete n[r]}else if(typeof n[r].scale!=="number"||n[r].scale<0){a.warning(P+": Key "+r+" has been removed from customizing due to invalid scale.");delete n[r]}}}},getExportInstance:function(e,t){var r,a;t=t?t:{};a=typeof e.fileType==="string"?e.fileType.toUpperCase():e.fileType;switch(a){case v.PDF:r="sap/ui/export/PortableDocument";break;default:r="sap/ui/export/Spreadsheet"}return new Promise(function(n){sap.ui.require([r],function(r){n(new r(e,t[a]))})})},getCountFromBinding:function(e){var t;if(typeof e.getCount==="function"){t=e.getCount()}else if(!e.isA("sap.ui.model.TreeBinding")&&typeof e.isLengthFinal==="function"&&e.isLengthFinal()){t=e.getLength()}if(typeof t!=="number"||t<0||isNaN(t)){t=null}return t},getHierarchyLevelProperty:function(e){if(!e||typeof e.isA!=="function"){return undefined}if(e.isA("sap.ui.model.odata.v2.ODataTreeBinding")&&typeof e.getTreeAnnotation==="function"){return e.getTreeAnnotation("hierarchy-level-for")}if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){var t=e.getAggregation(true);return t&&t.$DistanceFromRootProperty}return undefined},getHierarchyDrillStateProperty:function(e){if(!e||typeof e.isA!=="function"){return undefined}if(e.isA("sap.ui.model.odata.v2.ODataTreeBinding")&&typeof e.getTreeAnnotation==="function"){return e.getTreeAnnotation("hierarchy-drill-state-for")}if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){var t=e.getAggregation(true);return t&&t.$DrillStateProperty}return undefined},splitColumns:function(e,t){var r=[];if(typeof t!=="function"){t=function(){}}e.forEach(function(e){var a,n,i,o;if(Array.isArray(e.property)&&e.property.length>1){n=Object.assign({},e);n.property=e.property[0];n.label=t(n.property)||e.label;delete n.template;a=[n];e.property.slice(1).forEach(function(r,n){o=t(r);i={property:r,label:o||e.label+" ("+(n+1)+")"};a.push(i)})}if(e.unitProperty&&e.displayUnit!==false){n=Object.assign({},e);o=t(e.unitProperty);a=[n,{property:e.unitProperty,label:o||e.label+" (1)"}];if(n.type===h.Currency){n.displayUnit=false}if(n.type===h.Number){delete n.unitProperty}}if(e.timezoneProperty&&e.displayTimezone!==false){n=Object.assign({},e);o=t(e.timezoneProperty);a=[n,{property:e.timezoneProperty,label:o||e.label+" (1)"}];n.displayTimezone=false}r.push(a||e)});return r.flat()},getResourceBundle:function(){if(!E){return n.getLibraryResourceBundle("sap.ui.export",true).then(function(e){E=e;return E})}return Promise.resolve(E)},getFormatSettings:function(){if(!T){var e,t;t={};e=n.getConfiguration().getFormatSettings();t.calendar=n.getConfiguration().getCalendarType();t.datePattern=e.getDatePattern("medium");t.timePattern=e.getTimePattern("medium");t.delimiter=!!e.getNumberSymbol("group");if(typeof t.datePattern==="string"){t.datePattern=t.datePattern.toLowerCase()}if(typeof t.timePattern==="string"){t.timePattern=t.timePattern.toLowerCase().replace(/ a+/," AM/PM")}if(t.datePattern&&t.timePattern){t.dateTimePattern=t.datePattern+" "+t.timePattern}T=t}return T},getTimezoneTranslations:function(){const e=n.getConfiguration().getLocale();const t=u.getInstance(e);return t.getTimezoneTranslations()}};return C},true);
//# sourceMappingURL=ExportUtils.js.map