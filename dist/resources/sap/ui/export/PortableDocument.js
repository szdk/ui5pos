/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ui/core/Core","sap/ui/export/ExportBase","sap/ui/export/ExportUtils","sap/ui/export/library","sap/ui/export/util/PDFCapabilities","sap/ui/model/odata/v4/ODataModel","./ExportDialog","sap/m/BusyDialog"],function(e,t,i,r,o,n,a,s,u,p){"use strict";const c=n.FileType;const l=n.EdmType;var f=r.extend("sap.ui.export.PortableDocument",{constructor:function(e,i){r.call(this,e,i);if(!t.isA(this._mCapabilities,"sap.ui.export.util.PDFCapabilities")){this._mCapabilities=new a(this._mCapabilities)}["paperSize","orientation","font","fontSize","doEnableAccessibility","fitToPage","signature","signatureReason","pdfArchive","showPageNumber"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}}.bind(this))}});f.prototype.processDataSource=function(t){var i=null;var r=typeof t;if(!t){return null}if(r!="object"){e.error("Spreadsheet#processDataSource: Unable to apply data source of type "+r);return null}if(t.dataUrl&&t.serviceUrl){i=t}if(t.isA&&t.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){i=this.createDataSourceFromBinding(t)}return i};f.prototype.createDataSourceFromBinding=function(t){var i=null;if(t.isA(["sap.ui.model.ClientListBinding","sap.ui.model.ClientTreeBinding"])){e.error("Unable to create dataSource configuration due to not supported Binding: "+t.getMetadata().getName())}if(typeof t.getDownloadUrl==="function"){var r=t.getModel(),n=o.interceptUrl(t.getDownloadUrl("pdf")),a=o.interceptUrl(r.sServiceUrl),s=r.isA("sap.ui.model.odata.v4.ODataModel");var u=new URL(n,document.baseURI);u.hash="";this._oModel=r;u.search=u.search.split("&").filter(function(e){return e.indexOf("$format")==-1}).join("&");i={type:"odata",version:s?4:2,dataUrl:u.toString(),serviceUrl:this._resolveServiceUrl(a),headers:s?r.getHttpHeaders(true):r.getHeaders(),count:o.getCountFromBinding(t)}}return i};f.prototype._resolveServiceUrl=function(e){var t,i;e+=e.endsWith("/")?"":"/";t=/^[\./]/.test(e);i=this._mCapabilities.DocumentDescriptionReference;if(typeof i!=="string"||!i){return e.split("/").slice(0,-5).join("/")+"/default/iwbep/common/0001/"}i=i.endsWith("/")?i:i.split("/").slice(0,-1).join("/")+"/";var r=new URL(e,document.baseURI);r=new URL(i,r.href);return t?r.pathname:r.href};f.prototype._createDocumentDescription=function(e){const t=e.workbook;const i=e.dataSource.version;const r={Title:t.context.title,Format:{PaperSize:e.paperSize,Orientation:e.orientation},PDFStandard:{DoEnableAccessibility:e.doEnableAccessibility},TableColumns:[]};if(this._mCapabilities.ArchiveFormat){r.PDFStandard["UsePDFAConformance"]=e.pdfArchive}if(this._mCapabilities.CoverPage){const e=t.context.metainfo;r["CoverPage"]=[];if(e instanceof Array){e.forEach(function(e){if(i===2){e.items.forEach(function(t){const i={Title:e.name,Name:t.key,Value:t.value};r["CoverPage"].push(i)})}else{const t={Title:e.name,Content:[]};e.items.forEach(function(e){t["Content"].push({Name:e.key,Value:e.value})});r["CoverPage"].push(t)}})}}if(this._mCapabilities.FitToPage){r.Format["FitToPage"]={IsEnabled:e.fitToPage,MinimumFontSize:4}}if(this._mCapabilities.FontSize){r.Format["FontSize"]=Number(e.fontSize)}if(this._mCapabilities.HeaderFooter&&e.showPageNumber){r["Footer"]={Center:{Type:"PAGENUM"}}}if(this._mCapabilities.Signature){r["Signature"]={DoSign:e.signature,Reason:e.signatureReason}}if(this._mCapabilities.Treeview&&t.hierarchyLevel&&t.drillState){if(i===2){r["Hierarchy"]={DistanceFromRootElement:t.hierarchyLevel,DrillStateElement:t.drillState}}else{r.Format["TableFormat"]="TREE"}}t.columns.filter(function(e,t,i){var r=Array.isArray(e.property)?e.property[0]:e.property;if(!r){return false}return i.findIndex(function(e){var t=Array.isArray(e.property)?e.property[0]:e.property;return r===t})===t}).forEach(e=>{const t={Name:Array.isArray(e.property)?e.property[0]:e.property,Header:e.label};if(this._mCapabilities.IANATimezoneFormat&&e.type===l.DateTime){t.Format={DisplayFormat:i==2?"IANATIMEST":"IANA-Timestamp"};if(e.timezoneProperty){t.Format.IANATimezoneProperty=e.timezoneProperty}else if(e.timezone){t.Format.IANATimezone=e.timezone}}r.TableColumns.push(t)});return r};f.prototype._getEntitySetName=function(e){var t,i;i=e&&e.version||2;if(this._mCapabilities&&typeof this._mCapabilities.DocumentDescriptionCollection==="string"){t=this._mCapabilities.DocumentDescriptionCollection}return t||(i==4?"MyDocumentDescriptions":"SAP__MyDocumentDescriptions")};f.prototype._getModel=function(e){var t=e.version||2;return t===4?new s({serviceUrl:e.serviceUrl,synchronizationMode:"None"}):this._oModel};f.prototype._showWarning=function(e){var t,i;t={rows:e.dataSource.count,rowLimit:this._mCapabilities.ResultSizeMaximum,fileType:c.PDF};i=Promise.resolve();if(isNaN(t.rows)||t.rows>t.rowLimit){i=u.showWarningDialog(t)}return i};f.prototype._applyResultSize=function(e){var t,i;t=parseInt(this._mCapabilities.ResultSizeMaximum);if(!isNaN(t)&&t>0){i=new URL(e);i.search+="&$top="+t;e=i.toString()}return e};f.prototype.setDefaultExportSettings=function(e){var t=e&&e.workbook&&e.workbook.context;if(!(t instanceof Object)){t=e.workbook.context={}}if(typeof t.title==="string"&&t.title){return Promise.resolve()}return i.getLibraryResourceBundle("sap.ui.export",true).then(function(e){t.title=e.getText("XLSX_DEFAULT_TITLE")})};f.prototype.postDocumentDescription=function(e,t){var i,r,o;r=this._getModel(t);o="/"+this._getEntitySetName(t);if(!r||!r.isA(["sap.ui.model.odata.v4.ODataModel","sap.ui.model.odata.v2.ODataModel"])){return Promise.reject("Unsupported Model")}return new Promise(function(t,n){if(r.isA("sap.ui.model.odata.v4.ODataModel")){i=r.bindList(o);i.attachCreateCompleted(function(e){var i=e.getParameter("success");if(i){t(e.getParameter("context").getObject()["Id"])}else{n()}});i.create(e)}else{var a=r.bUseBatch;r.setUseBatch(false);r.create(o,e,{success:function(e){r.setUseBatch(a);t(e["Id"])},error:function(e){r.setUseBatch(a);n(e)}})}})};f.prototype.createBuildPromise=function(e){var t=this;var r;var n;var a=i.getLibraryResourceBundle("sap.ui.export");n=new p("PDFExportBusyDialog",{title:a.getText("PROGRESS_TITLE"),text:a.getText("PDF_GENERATION_IN_PROGRESS"),showCancelButton:true,close:function(e){if(e.getParameter("cancelPressed")){t.cancel()}n.destroy();n=null}});r=t._createDocumentDescription(e);n.open();return this._showWarning(e).then(function(){return t.postDocumentDescription(r,e.dataSource)}).then(function(i){return n&&t.sendRequest(e.dataSource.dataUrl,i)}).then(function(t){o.saveAsFile(t,e.fileName)}).catch(function(e){if(!e){return}e.text().then(function(e){u.showErrorMessage(e)}).catch(function(){u.showErrorMessage(a.getText("PDF_GENERIC_ERROR"))})}).finally(function(){n&&n.close()})};f.prototype.sendRequest=function(e,t){e=this._applyResultSize(e);return new Promise(function(i,r){var o=this.request=new XMLHttpRequest;o.open("GET",e);o.responseType="blob";o.setRequestHeader("Accept",this.getMimeType());o.setRequestHeader("SAP-Document-Description-Id",t);o.addEventListener("abort",function(){r(null)});o.addEventListener("error",function(){r("Error occured while requesting data")});o.addEventListener("load",function(){var e=o.status;if(e>=200&&e<400){i(o.response)}else{r(o.response)}});o.send()}.bind(this))};f.prototype.getMimeType=function(){return"application/pdf"};f.prototype.cancel=function(){if(this.request&&this.request.readyState!=XMLHttpRequest.DONE){this.request.abort();this.request=null}};f.prototype.destroy=function(){r.prototype.destroy.apply(this,arguments);this._oModel=null};return f});
//# sourceMappingURL=PortableDocument.js.map