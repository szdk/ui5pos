/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/m/P13nConditionPanel","sap/m/library","sap/ui/core/library","sap/ui/core/date/UI5Date","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/Device","sap/ui/core/InvisibleText","sap/ui/core/InvisibleMessage","sap/ui/core/ResizeHandler","sap/ui/core/Item","sap/ui/core/ListItem","sap/ui/model/odata/type/Boolean","sap/ui/model/type/String","sap/ui/model/odata/type/String","sap/ui/model/type/Date","sap/ui/model/type/Time","sap/ui/model/odata/type/DateTime","sap/ui/model/type/Float","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/Button","sap/m/OverflowToolbar","sap/m/OverflowToolbarLayoutData","sap/m/ToolbarSpacer","sap/m/Text","sap/m/SearchField","sap/m/CheckBox","sap/m/ComboBox","sap/m/Select","sap/m/Label","sap/m/Input","sap/m/DatePicker","sap/m/TimePicker","sap/m/DateTimePicker","sap/base/Log","sap/ui/comp/odata/type/StringDate","sap/ui/comp/p13n/P13nOperationsHelper","./P13nConditionPanelRenderer","sap/ui/model/json/JSONModel","sap/ui/model/Sorter"],function(e,t,i,a,n,o,s,r,l,d,p,u,g,c,h,y,f,_,m,S,C,v,I,T,F,b,x,O,L,V,D,k,P,E,M,K,w,N,A,B,G){"use strict";var R=t.ButtonType,H=t.P13nConditionOperation,U=t.P13nConditionOperationType,z=i.ValueState,j=[H.BT,H.EQ,H.LE,H.LT,H.GE,H.GT,H.NotBT,H.NotEQ,H.NotLE,H.NotLT,H.NotGE,H.NotGT],X=i.InvisibleMessageMode;var W=e.extend("sap.ui.comp.p13n.P13nConditionPanel",{metadata:{library:"sap.ui.comp.p13n",properties:{defaultOperation:{type:"string",group:"Misc",defaultValue:null},_calendarWeekSettings:{type:"string",group:"Misc",defaultValue:"",visibility:"hidden"}}},renderer:A.renderer});W.prototype.init=function(){this._oRbComp=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");e.prototype.init.apply(this);this._oOperationsHelper=new N};W.prototype.onBeforeRendering=function(){if(!this._oInvisibleMessage){this._oInvisibleMessage=l.getInstance()}};W.prototype.setOperations=function(e,t,i){var a=i?U.Exclude:U.Include;t=t||"default";if(this._oTypeOperations[t]===undefined){this._oTypeOperations[t]={}}this._oTypeOperations[t][a]=e;this._updateAllOperations()};W._createKeyFieldTypeInstance=function(e){var t;if(!e.typeInstance){switch(e.type){case"boolean":e.typeInstance=new g;break;case"numc":if(!(e.formatSettings&&e.formatSettings.isDigitSequence)){K.error("sap.m.P13nConditionPanel","NUMC type support requires isDigitSequence==true!");e.formatSettings=Object.assign({},e.formatSettings,{isDigitSequence:true})}t=e.formatSettings;if(e.maxLength){t=Object.assign({},t,{maxLength:e.maxLength})}if(!t.maxLength){K.error("sap.m.P13nConditionPanel","NUMC type suppport requires maxLength!")}e.typeInstance=new h({},t);break;case"date":e.typeInstance=new y(Object.assign({},e.formatSettings,{strictParsing:true}),{});break;case"time":e.typeInstance=new f(Object.assign({},e.formatSettings,{strictParsing:true}),{});break;case"datetime":e.typeInstance=new _(Object.assign({},e.formatSettings,{strictParsing:true}),{displayFormat:"Date"});var i=e.typeInstance;if(!i.oFormat){i.formatValue(a.getInstance(),"string")}if(i.oFormat){i.oFormat.oFormatOptions.UTC=false}break;case"stringdate":e.typeInstance=new w(Object.assign({},e.formatSettings,{strictParsing:true}));break;case"numeric":if(e.precision||e.scale){t={};if(e.precision){t["maxIntegerDigits"]=parseInt(e.precision)}if(e.scale){t["maxFractionDigits"]=parseInt(e.scale)}}e.typeInstance=new m(t);break;default:var n=e.formatSettings;if(e.maxLength){n=Object.assign({},n,{maxLength:e.maxLength})}e.typeInstance=new c({},n);break}}};W.prototype.setKeyFields=function(e){this._aKeyFields=e;this._aKeyFields.forEach(function(e){W._createKeyFieldTypeInstance(e)},this);this._updateKeyFieldItems(this._oConditionsGrid,true);this._updateAllConditionsEnableStates();this._createAndUpdateAllKeyFields();this._updateAllOperations();this._updateConditionFields()};W.prototype.setValues=function(e,t){t=t||"default";this._oTypeValues[t]=e};W.prototype.addOperation=function(e,t,i){var a=i?U.Exclude:U.Include;t=t||"default";if(this._oTypeOperations[t]===undefined){this._oTypeOperations[t]={}}if(this._oTypeOperations[t][a]===undefined){this._oTypeOperations[t][a]=[]}this._oTypeOperations[t][a].push(e);this._updateAllOperations()};W.prototype.getOperations=function(e,t){var i,a,n,o;e=e||"default";if(t!==undefined){i=t?U.Exclude:U.Include;o=this._oTypeOperations[e]&&this._oTypeOperations[e][i]||[]}else{a=this._oTypeOperations[e]&&this._oTypeOperations[e][U.Include]||[];n=this._oTypeOperations[e]&&this._oTypeOperations[e][U.Exclude]||[];o=a.concat(n)}return o};W.prototype._updatePaginatorToolbar=function(){if(this._sConditionType!=="Filter"||this.getMaxConditions()!=="-1"){return}var e=this._aConditionKeys.length;var t=1+Math.floor(Math.max(0,e-1)/this._iConditionPageSize);var i=1+Math.floor(this._iFirstConditionIndex/this._iConditionPageSize);var a=this.getParent();if(!this._oPaginatorToolbar){if(e>this._iConditionPageSize){this._createPaginatorToolbar();this.insertAggregation("content",this._oPaginatorToolbar,0);this._onGridResize()}else{if(a&&a.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=a.getHeaderText()}}return}}this._oPrevButton.setEnabled(this._iFirstConditionIndex>0);this._oNextButton.setEnabled(this._iFirstConditionIndex+this._iConditionPageSize<e);if(a&&a.setHeaderToolbar){if(!a.getHeaderToolbar()){this.removeAggregation("content",this._oPaginatorToolbar);a.setHeaderToolbar(this._oPaginatorToolbar);a.attachExpand(function(e){this._setToolbarElementVisibility(e.getSource().getExpanded()&&this._bPaginatorButtonsVisible)}.bind(this))}}if(a&&a.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=a.getHeaderText()}var n=this._sOrgHeaderText+(e>0?" ("+e+")":"");this._oHeaderText.setText(n)}else{this._oHeaderText.setText(e+" Conditions")}this._oPageText.setText(i+"/"+t);this._bPaginatorButtonsVisible=this._bPaginatorButtonsVisible||t>1;this._setToolbarElementVisibility(this._bPaginatorButtonsVisible);if(i>t){this._iFirstConditionIndex-=Math.max(0,this._iConditionPageSize);this._clearConditions();this._fillConditions()}var o=0;this._oConditionsGrid.getContent().forEach(function(e){if(e.select.getSelected()){o++}},this);if(t==i&&e-this._iFirstConditionIndex>o){this._clearConditions();this._fillConditions()}};W.prototype._setToolbarElementVisibility=function(e){this._oPrevButton.setVisible(e);this._oNextButton.setVisible(e);this._oPageText.setVisible(e);this._oFilterField.setVisible(false);this._setLayoutVisible(this._oAddButton,e);this._setLayoutVisible(this._oRemoveAllButton,e)};W.prototype._unregisterResizeHandler=function(){if(this._sContainerResizeListener){d.deregister(this._sContainerResizeListener);this._sContainerResizeListener=null}};W.prototype._registerResizeHandler=function(){if(this.getContainerQuery()){this._sContainerResizeListener=d.register(this._oConditionsGrid,this._onGridResize.bind(this));this._onGridResize()}};W.prototype._handleAddCondition=function(e,t,i){var a=e.getContent().indexOf(t);var n=this._createConditionRow(e,undefined,null,a+1,i);this._changeField(n);setTimeout(function(){if(n.keyField.getVisible()){n.keyField.focus();return}if(n.operation.getVisible()){n.operation.focus()}},500);this._updatePaginatorToolbar()};W.prototype._handleRemoveCondition=function(e,t){var i=e.getContent().indexOf(t);this._removeCondition(e,t);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(e,false)}if(i>=0){i=Math.min(i,e.getContent().length-1);var t=e.getContent()[i];setTimeout(function(){t.remove.focus()},500)}this._updatePaginatorToolbar()};W.prototype._getCurrentKeyFieldItem=function(e){if(e.getSelectedKey&&e.getSelectedKey()){var t=e.getSelectedKey();var i=this._aKeyFields;for(var a in i){var n=i[a];if(n.key===t){return n}}}return null};W.prototype._createConditionRow=function(e,t,i,a,n){var o,s=this,r=new B;if(a===undefined){a=e.getContent().length}var l=new S({width:"100%",defaultSpan:"L12 M12 S12",hSpacing:1,vSpacing:0,containerQuery:this.getContainerQuery()}).data("_key",i);for(var d in this._aConditionsFields){var p;var u=this._aConditionsFields[d];switch(u["Control"]){case"CheckBox":p=new O({enabled:false,layoutData:new C({span:u["Span"+this._sConditionType]})});this._setLayoutVisible(p,false);if(u["ID"]==="showIfGrouped"){p.setEnabled(true);p.setText(u["Label"]);p.attachSelect(function(){s._changeField(l)});p.setSelected(t?t.showIfGrouped:true)}else{if(t){p.setSelected(true);p.setEnabled(true)}}break;case"ComboBox":if(u["ID"]==="keyField"){p=new L({width:"100%",ariaLabelledBy:this._oInvisibleTextField});var g=p.setSelectedKey.bind(p);p.setSelectedKey=function(e){g(e);var t=s.getValidationExecutor();if(t){t()}};var c=p.setSelectedItem.bind(p);p.setSelectedItem=function(e){c(e);var t=s.getValidationExecutor();if(t){t()}};p.setLayoutData(new C({span:u["Span"+this._sConditionType]}));this._fillKeyFieldListItems(p,this._aKeyFields);if(p.attachSelectionChange){p.attachSelectionChange(function(t){var i=s.getValidationExecutor();if(i){i()}s._handleSelectionChangeOnKeyField(e,l)})}if(p.attachChange){p.attachChange(function(t){l.keyField.close();s._handleChangeOnKeyField(e,l)})}if(p.setSelectedItem){if(t){p.setSelectedKey(t.keyField);this._aKeyFields.forEach(function(e,i){var a=e.key;if(a===undefined){a=e}if(t.keyField===a){p.setSelectedItem(p.getItems()[i])}},this)}else{if(this.getUsePrevConditionSetting()&&!this.getAutoReduceKeyFieldItems()){if(a>0&&!i&&n){o=e.getContent()[a-1];if(o.keyField.getSelectedKey()){p.setSelectedKey(o.keyField.getSelectedKey())}else{if(!p.getSelectedItem()&&p.getItems().length>0){p.setSelectedItem(p.getItems()[0])}}}else{this._aKeyFields.some(function(e,t){if(e.isDefault){p.setSelectedItem(p.getItems()[t]);return true}if(!p.getSelectedItem()&&e.type!=="boolean"){p.setSelectedItem(p.getItems()[t])}},this);if(!p.getSelectedItem()&&p.getItems().length>0){p.setSelectedItem(p.getItems()[0])}}}else{this._aKeyFields.forEach(function(e,t){if(e.isDefault){p.setSelectedItem(p.getItems()[t])}},this)}}}}if(u["ID"]==="operation"){p=new L({width:"100%",ariaLabelledBy:this._oInvisibleTextOperator,layoutData:new C({span:u["Span"+this._sConditionType]})});p.addEventDelegate({onmouseup:function(){if(!this.isOpen()){this.showItems()}}},p);p.setFilterFunction(function(){return true});p.setModel(r);p.attachChange(function(t){s._validateOperationValue(t);s._handleChangeOnOperationField(e,l)});l[u["ID"]]=p;this._updateOperationItems(e,l);var h=this._getCurrentKeyFieldItem(l.keyField),y=this._getRelevantOperations(h);if(t){var f=this.getCurrentOparation(t);y.some(function(e){if(f===e){p.setSelectedKey(e);return true}},this)}else{if(this.getUsePrevConditionSetting()){if(a>0&&i===null){var o=e.getContent()[a-1],_=o.operation.getSelectedKey()||y[0];p.setSelectedKey(_)}else{if(this.getDefaultOperation()){p.setSelectedKey(this.getDefaultOperation())}else{p.setSelectedKey(y[0])}}}}}if(p.getSelectedItem&&p.getSelectedItem()&&p.getMetadata()._sUIDToken!=="box"){p.setTooltip(p.getSelectedItem().getTooltip())}break;case"TextField":var m=this._getCurrentKeyFieldItem(l.keyField);p=this._createValueField(m,u,l);p.oTargetGrid=e;if(p.addAriaDescribedBy){p.addAriaDescribedBy(this._oInvisibleTextOperatorInputValue)}if(t&&t[u["ID"]]!==undefined){var v=t[u["ID"]];if(p instanceof V){if(typeof v==="boolean"){p.setSelectedIndex(v?2:1)}}else if(v!==null&&l.oType){if(typeof v==="string"&&l.oType.getName()==="sap.ui.comp.odata.type.StringDate"){p.setValue(v)}else{var I=l&&l.operation&&j.indexOf(l.operation.getSelectedKey())!==-1;if(typeof v==="string"&&["String","sap.ui.model.odata.type.String","sap.ui.model.odata.type.Decimal"].indexOf(l.oType.getName())==-1){try{v=l.oType.parseValue(v,"string",I);p.setValue(l.oType.formatValue(v,"string",I))}catch(e){K.error("sap.m.P13nConditionPanel","Value '"+v+"' does not have the expected type format for "+l.oType.getName()+".parseValue()")}}else{p.setValue(l.oType.formatValue(v,"string",I));if(p.isA("sap.m.ComboBox")){if(v===""){p.getModel().attachEventOnce("batchRequestCompleted",function(e){e.setSelectedItem(e.getItems()[0])}.bind(null,p))}else{p.setSelectedKey(v)}}}}}else{p.setValue(v)}}break;case"Label":p=new D({text:u["Text"]+":",visible:this.getShowLabel(),layoutData:new C({span:u["Span"+this._sConditionType]})}).addStyleClass("conditionLabel");p.oTargetGrid=e;break}l[u["ID"]]=p;l.addContent(p)}this._addButtons(l,e);e.insertContent(l,a);this._updateOperationItems(e,l);this._changeOperationValueFields(e,l);this._updateAllConditionsEnableStates();this._updateConditionButtons(e);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(e,false)}if(this._sLayoutMode){this._updateLayout({name:this._sLayoutMode})}if(t){var T=this._getFormatedConditionText(t.operation,t.value1,t.value2,t.exclude,t.keyField,t.showIfGrouped);t._oGrid=l;t.value=T;this._oConditionsMap[i]=t}var F=l.operation.getSelectedKey();if(F==="BT"&&l.value1.setMinDate&&l.value2.setMaxDate){var b=l.value1.getDateValue();var x=l.value2.getDateValue();this._updateMinMaxDate(l,b,x)}else{this._updateMinMaxDate(l,null,null)}return l};W.prototype._fillOperationListItems=function(e,t,i){var a={items:[]};if(i==="_STRING_"||i==="_TEXT_"){i=""}if(i==="_TIME_"||i==="_DATETIME_"){i="_DATE_"}if(i==="_BOOLEAN_"||i==="_NUMC_"){i=""}e.destroyItems();if(t&&t.length>0){t.forEach(function(e){var t=this._oRb.getText("CONDITIONPANEL_OPTION"+i+e,null,true);if(t===undefined||t.startsWith("CONDITIONPANEL_OPTION")){t=this._oRb.getText("CONDITIONPANEL_OPTION"+e)}a.items.push({key:e,text:t,sorter:this._oOperationsHelper.isExcludeType(e)?this._oRbComp.getText("VALUEHELPDLG_EXCLUDE"):this._oRbComp.getText("VALUEHELPDLG_INCLUDE"),tooltip:t})}.bind(this));e.getModel().setData(a);e.bindAggregation("items",{path:"/items",sorter:new G("sorter",true,true),template:new u({key:"{key}",text:"{text}"})})}};W.prototype._validateOperationValue=function(e){var t=e.getSource(),i=t.getSelectedKey(),a=t.getValue();if(!i&&a){t.setValueState(z.Error);t.setValueStateText(this._oRbComp.getText("VALUEHELPDLG_VALUE_NOT_EXIST",a))}else{t.setValueState(z.None)}};W.prototype._fillKeyFieldListItems=function(e,t){e.destroyItems();for(var i in t){var a=t[i];e.addItem(new u({key:a.key,text:a.text,tooltip:a.tooltip}))}this._setLayoutVisible(e,e.getItems().length>1)};W.prototype._updateOperationItems=function(e,t){var i=this._getCurrentKeyFieldItem(t.keyField);var a=i&&i.type||"";var n=t.operation;var o=n.getSelectedItem();var s=this._getRelevantOperations(i);this._fillOperationListItems(n,s,a?"_"+a.toUpperCase()+"_":"");if(o&&n.getItemByKey(o.getKey())){n.setSelectedKey(o.getKey())}else{n.setSelectedItem(n.getItems()[1])}this._sConditionType="Filter";if(s[0]===H.Ascending||s[0]===H.Descending){this._sConditionType="Sort"}if(s[0]===H.GroupAscending||s[0]===H.GroupDescending){this._sConditionType="Group"}this._adjustValue1Span(t)};W.prototype._updateKeyFieldItems=function(e,t,i,a){var n=e.getContent().length;var o;var s={};if(!t){for(o=0;o<n;o++){var r=e.getContent()[o].keyField;var l=r.getSelectedKey();if(l!=null&&l!==""){s[l]=true}}}for(o=0;o<n;o++){var r=e.getContent()[o].keyField;var d=e.getContent()[o].select;var p=r.getSelectedKey();var g=0;var c=this._aKeyFields;if(r!==a){if(i){g=c.length-1}else{r.destroyItems()}for(g;g<c.length;g++){var h=c[g];if(h.key==null||h.key===""||!s[h.key]||h.key===p){r.addItem(new u({key:h.key,text:h.text,tooltip:h.tooltip}))}}this._setLayoutVisible(r,r.getItems().length>1)}if(p){r.setSelectedKey(p)}else if(r.getItems().length>0){r.setSelectedItem(r.getItems()[0])}if(!d.getSelected()){this._aKeyFields.some(function(e,t){if(e.isDefault){r.setSelectedItem(r.getItems()[t]);return true}if(!r.getSelectedItem()){if(e.type!=="boolean"){r.setSelectedItem(r.getItems()[t])}}},this)}if(r.getSelectedItem()){r.setTooltip(r.getSelectedItem().getTooltip())}}};W.prototype._adjustValue1Span=function(e){if(this._sConditionType==="Filter"&&e.value1&&e.operation){var t=e.operation;var i=this._aConditionsFields[5]["Span"+this._sConditionType];var a=t.getSelectedKey();if(a!==H.BT&&a!==H.NotBT){i=this._aKeyFields.length>1?"L5 M11 S10":"XL8 L8 M8 S10"}var n=e.value1.getLayoutData();if(n.getSpan()!==i){n.setSpan(i)}}};W.prototype._changeField=function(e,t){var i=e.keyField.getSelectedKey();if(e.keyField.getSelectedItem()){e.keyField.setTooltip(e.keyField.getSelectedItem().getTooltip())}else{e.keyField.setTooltip(null)}var a=e.operation.getSelectedKey();var n=this._oOperationsHelper.isExcludeType(a);a=n?this._oOperationsHelper.getCorrespondingIncludeOperation(a):a;if(e.operation.getSelectedItem()){e.operation.setTooltip(e.operation.getSelectedItem().getTooltip())}else{e.operation.setTooltip(null)}var o=function(e,t,i){var a,n,o=e.getParent();if(e.getDateValue&&!e.isA("sap.m.TimePicker")&&t.getName()!=="sap.ui.comp.odata.type.StringDate"){n=e.getDateValue();if(t&&n){if(i&&i.getParameter("valid")||e.isValidValue()){a=t.formatValue(n,"string")}else{a=""}}}else{a=this._getValueTextFromField(e);n=a;if(t&&t.getName()==="sap.ui.comp.odata.type.StringDate"){a=t.formatValue(n,"string")}else if(t&&a){try{var s=o&&o.operation&&j.indexOf(o.operation.getSelectedKey())!==-1;n=t.parseValue(a,"string",s);var r=this._getCurrentKeyFieldItem(o.keyField);if(r&&r.type==="numc"&&!s&&n===null){a=t.formatValue(n,"string",s);e.setValue(a)}t.validateValue(n);if(e.isA("sap.m.ComboBox")&&!e.getSelectedKey()||i&&e.getId()==i.getSource().getId()&&o.operation.getSelectedKey()===H.BT&&(this._isInvalidFiscalRange(o)||this._isFieldNumeric(o)&&this._isInvalidRange(o))){a=""}}catch(e){K.error("sap.m.P13nConditionPanel","not able to parse value "+a+" with type "+t.getName());a=""}}}return[n,a]}.bind(this);var s=o(e.value1,e.oType,t);var r=s[0],l=s[1];s=o(e.value2,e.oType,t);var d=s[0],p=s[1];if(this._hasSecondValue(a)){this._updateMinMaxDate(e,r,d)}else{this._updateMinMaxDate(e,null,null)}var u=this._getCurrentKeyFieldItem(e.keyField);if(u&&u.type==="numc"){if([H.Contains,H.EndsWith].indexOf(a)!=-1){r=e.oType.formatValue(r,"string")}}var g=e.showIfGrouped.getSelected();var c=e.select;var h="";var y;if(i===""||i==null){i=null;y=this._getKeyFromConditionGrid(e);this._removeConditionFromMap(y);this._enableCondition(e,false);var f=this._getIndexOfCondition(e);if(c.getSelected()){c.setSelected(false);c.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:y,index:f,operation:"remove",newData:null});this._bIgnoreSetConditions=false}return}this._enableCondition(e,true);h=this._getFormatedConditionText(a,l,p,n,i,g);var _={value:h,exclude:n,operation:a,keyField:i,value1:r,value2:this._hasSecondValue(a)?d:null,showIfGrouped:g};y=this._getKeyFromConditionGrid(e);if(h!==""||e.value1.isA("sap.m.ComboBox")){c.setSelected(true);c.setEnabled(true);var m="update";if(!this._oConditionsMap[y]){m="add"}this._oConditionsMap[y]=_;if(m==="add"){this._aConditionKeys.splice(this._getIndexOfCondition(e),0,y)}e.data("_key",y);this.fireDataChange({key:y,index:this._getIndexOfCondition(e),operation:m,newData:_})}else if(this._oConditionsMap[y]!==undefined){this._removeConditionFromMap(y);e.data("_key",null);var f=this._getIndexOfCondition(e);if(c.getSelected()){c.setSelected(false);c.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:y,index:f,operation:"remove",newData:null});this._bIgnoreSetConditions=false}}this._updatePaginatorToolbar()};W.prototype._getConditions=function(e){return{index:this._iConditions,key:this._createConditionKey(),exclude:this._oOperationsHelper.isExcludeType(e.oOperation),operation:e.oOperation,keyField:e.oKeyField,value1:e.oPastedValue,value2:null}};W.prototype._isFieldNumeric=function(e){var t=this._getCurrentKeyFieldItem(e.keyField),i=t.type;return!!(i==="numc"||i==="numeric")};W.prototype._isFiscalField=function(e){var t=this._getCurrentKeyFieldItem(e.keyField);return t.typeInstance&&t.typeInstance.isA("sap.ui.comp.odata.type.FiscalDate")};W.prototype._isInvalidRange=function(e){var t=e.value1.getValue(),i=e.value2.getValue();return!!(t&&i&&Number(e.oType.parseValue(t,"string"))>Number(e.oType.parseValue(i,"string")))};W.prototype._isInvalidFiscalRange=function(e){var t,i,a,n,o=e.value1.getValue(),s=e.value2.getValue(),r=this._getCurrentKeyFieldItem(e.keyField),l=r.typeInstance&&r.typeInstance.sFiscalType;if(!this._isFiscalField(e)||!o||!s){return false}if(l==="IsFiscalYearPeriod"||l==="IsFiscalYearQuarter"||l==="IsFiscalYearWeek"){if(o.indexOf("/")!==-1&&s.indexOf("/")!==-1){t=o.split("/")[0];a=s.split("/")[0];i=o.split("/")[1];n=s.split("/")[1];return i===n?t>a:i>n}}else{return parseFloat(o)>parseFloat(s)}};W.prototype._validateAndFormatFieldValue=function(e){var t=e.oSource;var i=t.getParent();var a;var n=this._oRbComp.getText("VALUEHELPVALDLG_FIELD_RANGE_MESSAGE"),o=i&&i.operation&&j.indexOf(i.operation.getSelectedKey())!==-1;if(t.getDateValue&&e){a=e.getParameter("value");var s=e.getParameter("valid");this._makeFieldValid(t,s);return}else{a=t.getValue&&t.getValue()}if(!i){return}if(this.getDisplayFormat()==="UpperCase"&&a){a=a.toUpperCase();t.setValue(a)}if(i.oType&&a){try{var r=i.oType.parseValue(a,"string",o);i.oType.validateValue(r);this._makeFieldValid(t,true);a=i.oType.formatValue(r,"string",o);t.setValue(a);if(i.operation.getSelectedKey()===H.BT){if(this._isFieldNumeric(i)&&this._isInvalidRange(i,e)||this._isInvalidFiscalRange(i,e)){this._makeFieldValid(t,false,n)}else{this._makeFieldValid(i.value1,true);this._makeFieldValid(i.value2,true)}}}catch(e){var l=e.message;this._makeFieldValid(t,false,l)}}else{this._makeFieldValid(t,true)}};W.prototype._changeOperationValueFields=function(t,i){e.prototype._changeOperationValueFields.apply(this,arguments);var a=i.getContent().length,n=i.remove,o=i.indexOfContent(n),s=a-1;if(o!==s){i.insertContent(n,s)}};W.prototype._updateLayout=function(e){};W.prototype._updateConditionFields=function(){this._aConditionsFields=this._createConditionsFields()};W.prototype._addButtons=function(e,t){var i=this,a;var n=new v({type:R.Transparent,icon:o.getIconURI("decline"),tooltip:this._oRb.getText("CONDITIONPANEL_REMOVE"+(this._sAddRemoveIconTooltipKey?"_"+this._sAddRemoveIconTooltipKey:"")+"_TOOLTIP"),press:function(){a=document.getElementById(i.getId()+"-firstfe");if(a&&a.focus){a.focus()}i._oInvisibleMessage.announce(i._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_CONDITION_REMOVED"),X.Polite);i._handleRemoveCondition(this.oTargetGrid,e)},layoutData:new C({span:"XL1 L1 M1 S1"})});n.oTargetGrid=t;e.addContent(n);e["remove"]=n;var s=new v({text:this._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_ADD"),press:function(){a=document.getElementById(i.getId()+"-firstfe");if(a&&a.focus){a.focus()}i._oInvisibleMessage.announce(i._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_CONDITION_ADDED"),X.Polite);i._handleAddCondition(this.oTargetGrid,e,true)},layoutData:new C({span:"XL2 L3 M3 S3",indent:"XL9 L8 M8 S7",linebreak:true}),ariaDescribedBy:i._oInvisibleTextOperatorAddButton});s.oTargetGrid=t;s.addStyleClass("conditionAddBtnFloatRight");s.addStyleClass("conditionAddBtnMarginTop");e.addContent(s);e["add"]=s};W.prototype.getCurrentOparation=function(e){return e.exclude?this._oOperationsHelper.getCorrespondingExcludeOperation(e.operation):e.operation};W.prototype._hasSecondValue=function(t){return e.prototype._hasSecondValue.apply(this,arguments)||t===H.NotBT};W.prototype._hasNoValues=function(t){return e.prototype._hasNoValues.apply(this,arguments)||t===H.NotEmpty};W.prototype._createConditionsFields=function(){return[{ID:"select",Label:"",SpanFilter:"L1 M1 S1",SpanSort:"L1 M1 S1",SpanGroup:"L1 M1 S1",Control:"CheckBox",Value:""},{ID:"keyFieldLabel",Text:"Sort By",SpanFilter:"L1 M1 S1",SpanSort:"L1 M1 S1",SpanGroup:"L1 M1 S1",Control:"Label"},{ID:"keyField",Label:"",SpanFilter:"L3 M5 S10",SpanSort:"L5 M5 S12",SpanGroup:"L4 M4 S12",Control:"ComboBox"},{ID:"operationLabel",Text:"Sort Order",SpanFilter:"L1 M1 S1",SpanSort:"L1 M1 S1",SpanGroup:"L1 M1 S1",Control:"Label"},{ID:"operation",Label:"",SpanFilter:this._aKeyFields.length>1?"L3 M6 S10":"XL3 L3 M3 S10",SpanSort:s.system.phone?"L5 M5 S8":"L5 M5 S9",SpanGroup:"L2 M5 S10",Control:"ComboBox"},{ID:"value1",Label:this._sFromLabelText,SpanFilter:this._aKeyFields.length>1?"L3 M10 S10":"XL4 L4 M4 S10",SpanSort:"L3 M10 S10",SpanGroup:"L3 M10 S10",Control:"TextField",Value:""},{ID:"value2",Label:this._sToLabelText,SpanFilter:this._aKeyFields.length>1?"L2 M10 S10":"XL4 L4 M4 S10",SpanSort:"L2 M10 S10",SpanGroup:"L2 M10 S10",Control:"TextField",Value:""},{ID:"showIfGrouped",Label:this._sShowIfGroupedLabelText,SpanFilter:"L1 M10 S10",SpanSort:"L1 M10 S10",SpanGroup:"L3 M4 S9",Control:"CheckBox",Value:"false"}]};W.prototype._getConditionsGridAtPosition=function(e){var t=this._oConditionsGrid.getContent();if(e>=t.length){return null}return t[e]};W.prototype._getConditionsCount=function(){var e=this._oConditionsGrid.getContent();return e.length};W.prototype.fireDataChange=function(e){var t,i=e.newData;if(i){t=i.operation;i.operation=this._oOperationsHelper.isExcludeType(t)?this._oOperationsHelper.getCorrespondingIncludeOperation(t):t}return n.prototype.fireEvent.call(this,"dataChange",e)};W.prototype._makeFieldValid=function(e,t,i,a){if(a){var n=e.getSelectedItem();if(!n){e.setValueState(z.Error)}else{e.setValueState(z.None)}}else if(t){e.setValueState(z.None);e.setValueStateText("")}else{e.setValueState(z.Warning);e.setValueStateText(i?i:this._sValidationDialogFieldMessage)}};W.prototype._getRelevantOperations=function(e){var t,i=e&&e.typeInstance,a=i&&e.typeInstance.oConstraints&&e.typeInstance.oConstraints.isDigitSequence,n=i&&(e.typeInstance.sFiscalType==="IsFiscalPeriod"||e.typeInstance.sFiscalType==="IsFiscalYearPeriod"),o=a&&n?"numcFiscal":e&&e.type,s=e&&e.type&&this.getOperations(o);if(e&&e.operations){t=e.operations}else if(Array.isArray(s)&&s.length>0){t=s}else{t=this.getOperations("default")}return t};W.prototype._handleComboBoxChangeEvent=function(e,t){var i=t.getSource();this._makeFieldValid(i,true,undefined,true);if(i.getValueState()===z.None){this._changeField(e)}};W.prototype._createValueField=function(e,t,i){var a,n,o=this,s,r={value:t["Value"],width:"100%",placeholder:t["Label"],change:function(e){o._validateAndFormatFieldValue(e);o._changeField(i,e)},layoutData:new C({span:t["Span"+this._sConditionType]})};if(e&&e.typeInstance){var l=e.typeInstance;n=this._findConfig(l,"ctrl");if(n==="DateTimePicker"&&l.getMetadata().getName()==="sap.ui.model.odata.type.DateTime"){if(!(l.oConstraints&&l.oConstraints.isDateOnly)){K.error("sap.m.P13nConditionPanel","sap.ui.model.odata.type.DateTime without displayFormat = Date is not supported!");l.oConstraints=Object.assign({},l.oConstraints,{isDateOnly:true})}n="DatePicker"}i.oType=l;if(n=="select"){var d=[];var u=e.values||this._oTypeValues[n]||["",l.formatValue(false,"string"),l.formatValue(true,"string")];u.forEach(function(e,t){d.push(new p({key:t.toString(),text:e.toString()}))});r={width:"100%",items:d,change:function(){o._changeField(i);o._makeFieldValid(a,true)},layoutData:new C({span:t["Span"+this._sConditionType]})};a=new V(r)}else if(n=="TimePicker"){if(l.oFormatOptions&&l.oFormatOptions.style){r.displayFormat=l.oFormatOptions.style}a=new E(r)}else if(n=="DateTimePicker"){if(l.oFormatOptions&&l.oFormatOptions.style){r.displayFormat=l.oFormatOptions.style}s=this.getProperty("_calendarWeekSettings");if(s){r.calendarWeekNumbering=s}a=new M(r)}else if(n==="DatePicker"){if(l.oFormatOptions){r.displayFormat=l.oFormatOptions.style||l.oFormatOptions.pattern;if(l.isA("sap.ui.comp.odata.type.StringDate")){r.valueFormat="yyyyMMdd"}}s=this.getProperty("_calendarWeekSettings");if(s){r.calendarWeekNumbering=s}a=new P(r)}else{var g=this.data("dropdownFields");a=new k(r);if(g){for(var c=0;c<g.length;c++){if(g[c].name===e.key){r={width:"100%",items:[],change:this._handleComboBoxChangeEvent.bind(this,i),layoutData:new C({span:t["Span"+this._sConditionType]})};a=new L(r);break}}}if(this._fSuggestCallback){e=this._getCurrentKeyFieldItem(i.keyField);if(e&&e.key){var h=this._fSuggestCallback(a,e.key);if(h){a._oSuggestProvider=h}}}}}else{i.oType=null;a=new k(r)}if(n!=="boolean"&&n!=="enum"&&a){a.onpaste=function(e){var t;if(window.clipboardData){t=window.clipboardData.getData("Text")}else{t=e.originalEvent.clipboardData.getData("text/plain")}var i=e.srcControl.getParent();var a=t.split(/\r\n|\r|\n/g);if(a&&a[a.length-1].trim()===""){a.pop()}var n=i.operation;var s=n.getSelectedKey();if(a&&a.length>1&&s!=="BT"){setTimeout(function(){var e=a?a.length:0;var t=o._getCurrentKeyFieldItem(i.keyField);var n=i.operation;for(var s=0;s<e;s++){if(o._aConditionKeys.length>=o._getMaxConditionsAsNumber()){break}var r=a[s].trim();if(r){var l;if(t.typeInstance){try{l=t.typeInstance.parseValue(r,"string");t.typeInstance.validateValue(l)}catch(e){K.error("sap.m.P13nConditionPanel.onPaste","not able to parse value "+r+" with type "+t.typeInstance.getName());r="";l=null}if(!l){continue}}var d={index:o._iConditions,key:o._createConditionKey(),exclude:o.getExclude()||o._oOperationsHelper.isExcludeType(n.getSelectedKey()),operation:n.getSelectedKey(),keyField:t.key,value1:l,value2:null};o._addCondition2Map(d);o.fireDataChange({key:d.key,index:d.index,operation:"add",newData:d})}}o._clearConditions();o._fillConditions()},0)}}}if(e&&e.maxLength&&a.setMaxLength){var y=-1;if(typeof e.maxLength==="string"){y=parseInt(e.maxLength)}if(typeof e.maxLength==="number"){y=e.maxLength}if(y>0&&(!a.getShowSuggestion||!a.getShowSuggestion())){a.setMaxLength(y)}}var f={onAfterRendering:function(e){var t=e.srcControl.getDomRef("inner");if(t){t.setAttribute("inputmode","decimal");t.setAttribute("pattern","[0-9]+([.,][0-9]+)?")}}};if(e&&(e.type==="numeric"||e.type==="numc")&&(this._isPhone()||this._isTablet())){a.addDelegate(f,this)}return a};W.prototype._enableCondition=function(e,t){var i=this._getCurrentKeyFieldItem(e.keyField);i&&i.type==="boolean"?e.operation.setEnabled(false):e.operation.setEnabled(t);e.value1.setEnabled(t);e.value2.setEnabled(t);e.showIfGrouped.setEnabled(t)};W.prototype._getValueTextFromField=function(e){if(e instanceof V){return e.getSelectedItem()?e.getSelectedItem().getText():""}if(e.isA("sap.m.ComboBox")){return e.getSelectedItem()?e.getSelectedItem().getKey():""}return e.getValue()};W.prototype._isPhone=function(){return!!s.system.phone};W.prototype._isTablet=function(){return!!(s.system.tablet&&!s.system.desktop)};return W});
//# sourceMappingURL=P13nConditionPanel.js.map