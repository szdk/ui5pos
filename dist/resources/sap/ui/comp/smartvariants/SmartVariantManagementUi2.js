/*!
 * SAPUI5
 * (c) Copyright 2009-2023 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/library","sap/ui/comp/library","sap/m/VariantManagement","sap/ui/comp/variants/VariantItem","sap/ui/model/base/ManagedObjectModel","sap/base/Log"],function(t,e,a,i,r,n,o){"use strict";var s=e.TitleLevel;var l=t.extend("sap.ui.comp.smartvariants.SmartVariantManagementUi2",{metadata:{library:"sap.ui.comp",properties:{enabled:{type:"boolean",group:"Misc",defaultValue:true},maxWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},standardItemText:{type:"string",group:"Misc",defaultValue:null},headerLevel:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:s.Auto},titleStyle:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:s.Auto}},aggregations:{personalizableControl:{type:"sap.ui.comp.smartvariants.PersonalizableInfo",multiple:false},_embeddedVM:{type:"sap.m.VariantManagement",multiple:false,visibility:"hidden"}},events:{initialise:{},afterSave:{},save:{parameters:{name:{type:"string"},overwrite:{type:"boolean"},key:{type:"string"},def:{type:"boolean"}}},manage:{parameters:{renamed:{type:"object[]"},deleted:{type:"string[]"},def:{type:"string"}}},select:{parameters:{key:{type:"string"}}}}},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e);t.style("max-width",e.getMaxWidth());t.openEnd();t.renderControl(e._oVM);t.close("div")}}});l.prototype.init=function(){t.prototype.init.apply(this);this.STANDARDVARIANTKEY="*standard*";this.addStyleClass("sapUiCompVarMngmt");this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._oVM=new i(this.getId()+"-vm",{supportFavorites:false,supportApplyAutomatically:false,supportPublic:false,supportContexts:false});this.setAggregation("_embeddedVM",this._oVM,true);this._oVM.setStandardVariantKey(this.STANDARDVARIANTKEY);this._oManagedObjectModel=new n(this);this.setModel(this._oManagedObjectModel,"$compSmartVariantsUi2");this._oVM.attachManage(this._fireManage,this);this._oVM.attachSave(this._fireSave,this);this._oVM.attachSelect(this._fireSelect,this);this._oStandardVariant=null;this._oPersController=null;this._sKeyName=null;this._oContainer=null;this._oVariantSet=null;this._bindProperties()};l.prototype._bindProperties=function(){this._oVM.bindProperty("level",{path:"/headerLevel",model:"$compSmartVariantsUi2"});this._oVM.bindProperty("titleStyle",{path:"/titleStyle",model:"$compSmartVariantsUi2"})};l.prototype.getVariantItems=function(){return this._oVM.getItems()};l.prototype.isPageVariant=function(){return false};l.prototype.getVariantContent=function(t,e){var a=null;if(e===this.getStandardVariantKey()){a=this._getStandardVariant()}else{if(this._oVariantSet){var i=this._oVariantSet.getVariant(e);if(i){a=this._getContent(i)}}}return a};l.prototype.getExecuteOnSelectForStandardVariant=function(){return false};l.prototype.currentVariantSetModified=function(t){this._oVM.setModified(t)};l.prototype.currentVariantGetModified=function(){return this._oVM.getModified()};l.prototype.getCurrentVariantId=function(){var t=this._oVM.getSelectedKey();if(t===this.getStandardVariantKey()){t=""}return t};l.prototype.setSelectionKey=function(t){this._oVM.setSelectedKey(t)};l.prototype.getItemByKey=function(t){return this._oVM._getItemByKey(t)};l.prototype.setDefaultVariantKey=function(t){this._oVM.setDefaultKey(t)};l.prototype.getDefaultVariantKey=function(){return this._oVM.getDefaultKey()};l.prototype.setInitialSelectionKey=function(t){this.setSelectionKey(t)};l.prototype.getInitialSelectionKey=function(){return this._oVM.getSelectedKey()};l.prototype.getSelectionKey=function(){return this._oVM.getSelectedKey()};l.prototype.addVariantItem=function(t){this._oVM.addItem(t)};l.prototype.insertVariantItem=function(t,e){this._oVM.insertItem(t,e)};l.prototype.removeVariantItem=function(t){this._oVM.removeItem(t)};l.prototype.setCurrentVariantKey=function(t){this.setSelectionKey(t)};l.prototype._fireSelect=function(t){this.fireSelect(t.getParameters())};l.prototype._fireSave=function(t){var e=t.getParameters();if(e.hasOwnProperty("execute")){e.exe=e.execute}this.fireSave(e)};l.prototype._fireManage=function(t){var e=t.getParameters();this.fireManage(e)};l.prototype.getStandardVariantKey=function(){return this.STANDARDVARIANTKEY};l.prototype._determineStandardVariantName=function(){var t=this.oResourceBundle.getText("VARIANT_MANAGEMENT_STANDARD");if(this.getStandardItemText()){t=this.getStandardItemText()}return t};l.prototype.removeAllVariantItems=function(){this._oVM.removeAllItems()};l.prototype._createStandardVariantItem=function(){this._createVariantItem(this.getStandardVariantKey(),this._determineStandardVariantName(),{rename:false,remove:false,changeable:false});this.setSelectionKey(this.getStandardVariantKey())};l.prototype._getIdxSorted=function(t){var e=this.getVariantItems();var a=t.toUpperCase();var i=e.findIndex(function(t,e){if(e>0){if(t.getTitle().toUpperCase()>a){return true}}return false});return i>-1?i:e.length};l.prototype._variantItemChange=function(t){var e,a,i;if(t&&t.oSource&&t.oSource.isA("sap.ui.comp.variants.VariantItem")){i=t.oSource;if(i.getKey()!==this.STANDARDVARIANTKEY){a=t.getParameter("propertyName");if(a==="text"){this.removeVariantItem(i);e=this._getIdxSorted(i.getText());this.insertVariantItem(i,e)}}}};l.prototype._createVariantItem=function(t,e,a){var i=t===this.getStandardVariantKey()?0:this._getIdxSorted(e);if(!a){a={rename:true,remove:true,changeable:true}}a.key=t;a.text=e;a.title=e;a.visible=true;var n=new r(a);n.attachChange(this._variantItemChange.bind(this));this.insertVariantItem(n,i)};l.prototype.getVariantItems=function(){return this._oVM.getItems()};l.prototype.getInErrorState=function(){return this._oVM.getInErrorState()};l.prototype.clearVariantSelection=function(){this.setSelectionKey(this.getStandardVariantKey())};l.prototype.setCurrentVariantId=function(t,e){var a;var i=t;if(!i){i=this.getStandardVariantKey()}else{if(!this.getItemByKey(i)){i=this.getStandardVariantKey()}}if(this._oVariantSet){a=this.getVariantContent(this._oPersController,i);if(a){this.setSelectionKey(i);if(e!==true){this._applyVariantContent(a)}}}};l.prototype.addPersonalizableControl=function(t){this.setAggregation("personalizableControl",t,true);if(t.getControl()){this._oPersController=sap.ui.getCore().byId(t.getControl())}this._sKeyName=t.getKeyName();return this};l.prototype._getUShellContainer=function(){return sap.ui.require("sap/ushell/Container")};l.prototype.initialise=function(){var t=this._getPersistencyKey();if(!t){o.warning("PersistencyKey not set");this.fireEvent("initialise");return}var e=this;var a=this._getUShellContainer();if(a){a.getServiceAsync("Personalization").then(function(a){a.getContainer(t,{validity:Infinity}).fail(function(){o.error("Loading personalization container failed");e._setErrorValueState(e.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"));e.fireEvent("initialise")}).done(function(t){e._readPersonalization(t)})},function(){o.error("Loading personalization service failed");e._setErrorValueState(e.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"));e.fireEvent("initialise")});return}o.error("Could not obtain the personalization container");this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"));this.fireEvent("initialise")};l.prototype._setSelectedVariant=function(){var t=null;if(this._oVariantSet){var e=this.getSelectionKey();if(e){t=this._oVariantSet.getVariant(e);if(t){this._applyVariant(t)}}}};l.prototype._reCreateVariantEntries=function(){var t=null;var e=null;var a;if(this._oVariantSet){var i=this._oVariantSet.getVariantNamesAndKeys();if(i){for(t in i){if(t){this._createVariantItem(i[t],t)}}e=this._oVariantSet.getCurrentVariantKey();a=this._oVariantSet.getVariant(e);if(!a){e=this.getStandardVariantKey()}this.setDefaultVariantKey(e);this.setInitialSelectionKey(e)}}};l.prototype._getVariantSetAdapter=function(t){if(!t){return Promise.resolve(null)}return new Promise(function(e){sap.ui.require(["sap/ushell/services/personalization/VariantSetAdapter"],function(a){e(new a(t))})})};l.prototype._createVariantEntries=function(){this.removeAllVariantItems();this._createStandardVariantItem();return this._getVariantSetAdapter(this._oContainer).then(function(t){if(t){this._oVariantSet=t.getVariantSet("filterBarVariantSet");if(this._oVariantSet){this._reCreateVariantEntries()}else{this._oVariantSet=t.addVariantSet("filterBarVariantSet")}this._setStandardVariant();if(this.getDefaultVariantKey()!==this.getStandardVariantKey()){this._setSelectedVariant()}}this.fireEvent("initialise")}.bind(this))};l.prototype._readPersonalization=function(t){this._oContainer=t;if(this._oContainer){this._createVariantEntries()}};l.prototype._savePersonalizationContainer=function(){var t=this;if(this._oContainer){this._oContainer.save().fail(function(){o.error("Saving personalization data failed");t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"))}).done(function(){o.info("Saving personalization data succeeded");t.fireEvent("afterSave")})}};l.prototype.fireSave=function(t){var e=null,a=null;var i;if(!this._oVariantSet){return}if(t){if(t.overwrite){if(t.key){e=this._oVariantSet.getVariant(t.key)}}else{if(t.name){e=this._oVariantSet.addVariant(t.name);a=e;i=a.getVariantKey();this._createVariantItem(i,t.name);this.setInitialSelectionKey(i)}}if(e){this.fireEvent("save",t);var r=this._fetchVariant();if(r){e.setItemValue("filterBarVariant",r.filterBarVariant);e.setItemValue("filterbar",r.filterbar);e.setItemValue("basicSearch","");if(r.basicSearch){e.setItemValue("basicSearch",r.basicSearch)}i=e.getVariantKey();if(t.def){if(i){this._oVariantSet.setCurrentVariantKey(i)}}else{var n=this._oVariantSet.getCurrentVariantKey();if(i===n){this._oVariantSet.setCurrentVariantKey(null)}}}this.currentVariantSetModified(false);this._savePersonalizationContainer()}}};l.prototype._setStandardVariant=function(){if(this._oPersController&&this._oPersController.fireBeforeVariantSave){this._oPersController.fireBeforeVariantSave(a.STANDARD_VARIANT_NAME)}this._oStandardVariant=this._fetchVariant()};l.prototype._getStandardVariant=function(){return this._oStandardVariant};l.prototype._getVariantNamesAndKeys=function(){return this._oVariantSet.getVariantNamesAndKeys()};l.prototype._reorderList=function(t){var e=this.getItemByKey(t);if(e){this.removeVariantItem(e);var a=this._getIdxSorted(e.getTitle());this.insertVariantItem(e,a)}};l.prototype.fireManage=function(t){var e;var a=null,i=null;var r;if(!this._oVariantSet){return}if(t){a=t.renamed;i=t.deleted;if(a){for(e=0;e<a.length;e++){r=this._oVariantSet.getVariant(a[e].key);if(r){r.setVariantName(a[e].name);this._reorderList(a[e].key)}}}if(i){var n=this._oVariantSet.getCurrentVariantKey();for(e=0;e<i.length;e++){r=this._oVariantSet.getVariant(i[e]);if(r){this._oVariantSet.delVariant(i[e]);if(n&&n===r.getVariantKey()){this._oVariantSet.setCurrentVariantKey(null);this.setSelectionKey(this.getStandardVariantKey());this.fireSelect({key:this.getStandardVariantKey()})}}}}if(t.def){r=this._oVariantSet.getVariant(t.def);if(r||t.def===this.getStandardVariantKey()){this._oVariantSet.setCurrentVariantKey(t.def)}}if(i&&i.length>0||a&&a.length>0||t.def){this._savePersonalizationContainer()}}};l.prototype.fireSelect=function(t){var e=null;if(t&&t.key){if(this._oVariantSet){if(t.key===this.getStandardVariantKey()){e=this._getStandardVariant()}else{e=this._oVariantSet.getVariant(t.key)}}}if(e){this.currentVariantSetModified(false);this._applyVariant(e)}};l.prototype._getContent=function(t){var e=null;if(t){if(t.getItemValue){e={filterbar:t.getItemValue("filterbar"),filterBarVariant:t.getItemValue("filterBarVariant")};var a=t.getItemValue("basicSearch");if(a){e.basicSearch=a}}else{e=t}}return e};l.prototype._applyVariant=function(t){var e=this._getContent(t);this._applyVariantContent(e)};l.prototype._applyVariantContent=function(t){if(t&&this._oPersController&&this._oPersController.applyVariant){this._oPersController.applyVariant(t)}};l.prototype._fetchVariant=function(){if(this._oPersController&&this._oPersController.fetchVariant){return this._oPersController.fetchVariant()}return null};l.prototype._getPersistencyKey=function(){if(this._oPersController&&this._sKeyName){return this._oPersController.getProperty(this._sKeyName)}return null};l.prototype._setErrorValueState=function(t){this.setEnabled(false)};l.prototype.exit=function(){t.prototype.exit.apply(this,arguments);if(this._oManagedObjectModel){this._oManagedObjectModel.destroy();this._oManagedObjectModel=undefined}this._oVM.detachManage(this._fireManage,this);this._oVM.detachSelect(this._fireSelect,this);this._oVM.detachSave(this._fireSave,this);this._oStandardVariant=null;this._oPersController=null;this._sKeyName=null;this._oContainer=null;this._oVariantSet=null};return l});
//# sourceMappingURL=SmartVariantManagementUi2.js.map