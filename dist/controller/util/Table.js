sap.ui.define(["sap/m/Table","sap/m/Column","sap/m/Text","sap/m/ColumnListItem","sap/m/p13n/Engine","sap/m/p13n/SelectionController","sap/m/p13n/SortController","sap/m/p13n/GroupController","sap/m/table/ColumnWidthController","sap/m/p13n/MetadataHelper","sap/ui/core/library","sap/ui/model/Sorter","sap/m/IllustratedMessage","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/Button","sap/m/MenuButton","sap/m/Menu","sap/m/MenuItem","sap/ui/export/Spreadsheet","sap/m/MessageBox","sap/m/ToolbarSeparator"],function(t,e,o,l,n,a,s,r,i,h,c,d,p,m,u,f,b,g,T,x,y,C){"use strict";return class{constructor(t){this.data=t;this.i18n=t.i18n;this.sorter=[];this.filters=[];this.generateTable();this.p13n=t.toolbar&&t.toolbar.p13n?this.registerP13n():null;this.generateToolbar()}getTable=()=>this.table;refreshBinding=()=>{this.table.bindItems({path:this.data.itemsBinding.path,parameters:this.data.itemsBinding.parameters,template:this.cellContainer,templateShareable:true,sorter:this.sorter,filters:this.filters})};applyFilter=t=>{this.filters=t;this.refreshBinding()};generateToolbar=()=>{let t=this.data;if(!t.toolbar||!Object.keys(t.toolbar).find(t=>!!t))return;this.toolbar=new m;if(this.data.customToolbar&&this.data.customToolbar.start&&this.data.customToolbar.start.length>0){for(let t of this.data.customToolbar.start)this.toolbar.addContent(t)}if(this.data.customToolbar&&this.data.customToolbar.mid&&this.data.customToolbar.mid.length>0){this.toolbar.addContent(new u);for(let t of this.data.customToolbar.mid)this.toolbar.addContent(t)}this.toolbar.addContent(new u);if(this.data.customToolbar&&this.data.customToolbar.end&&this.data.customToolbar.end.length>0){for(let t of this.data.customToolbar.end)this.toolbar.addContent(t);this.toolbar.addContent(new C)}if(t.toolbar.p13n){let t=new f({icon:"sap-icon://provision",text:this.i18n.getText("layout"),type:sap.m.ButtonType.Transparent,busyIndicatorDelay:0,press:e=>{t.setBusy(true);t.setEnabled(false);this.showP13n().then(()=>{t.setBusy(false);t.setEnabled(true)})}});this.toolbar.addContent(t)}if(t.toolbar.excel){let t=new f({text:this.i18n.getText("export_excel"),tooltip:this.i18n.getText("export_excel"),type:sap.m.ButtonType.Transparent,icon:"sap-icon://excel-attachment",press:()=>{t.setEnabled(false);this.exportExcel().catch(()=>{}).finally(()=>t.setEnabled(true))}});this.toolbar.addContent(t)}if(t.toolbar.growSize){let t=[];for(let e of["20","50","100","1000"])t.push(new T({key:e,text:this.i18n.getText(e)}));let e=new b({tooltip:this.i18n.getText("items_count"),text:this.table.getGrowing()?this.table.getGrowingThreshold():null,icon:"sap-icon://documents",type:sap.m.ButtonType.Transparent,menu:new g({items:t,itemSelected:t=>{let o=t.getParameter("item");if(!o)return;this.table.setGrowing(true);this.table.setGrowingThreshold(parseInt(o.getKey()));e.setText(o.getText())}})});this.toolbar.addContent(e)}if(t.toolbar.pin){let t=this.table.getSticky()||[];let e=new b({tooltip:this.i18n.getText("pin"),text:this.i18n.getText("pin"),icon:"sap-icon://pushpin-on",type:sap.m.ButtonType.Transparent,menu:new g({items:[new T({text:this.i18n.getText("toolbar"),key:"HeaderToolbar",icon:t.indexOf("HeaderToolbar")>-1?"sap-icon://complete":"sap-icon://border"}),new T({text:this.i18n.getText("column_header"),key:"ColumnHeaders",icon:t.indexOf("ColumnHeaders")>-1?"sap-icon://complete":"sap-icon://border"})],itemSelected:t=>{let e=[...this.table.getSticky()||[]];let o=t.getParameter("item");let l=e.indexOf(o.getKey());if(l<0){e.push(o.getKey());o.setIcon("sap-icon://complete")}else{e.splice(l,1);o.setIcon("sap-icon://border")}this.table.setSticky(e)}})});this.toolbar.addContent(e)}this.table.setHeaderToolbar(this.toolbar)};exportExcel=()=>{let t,e;let o=new Promise((o,l)=>{t=o;e=l});let l=[];for(let t of this.table.getColumns(true)){let e=t.data("key")?this.colP13nMap[t.data("key")]:this.colNonP13n[parseInt(t.data("idx"))];if(e&&e.columnData&&e.columnData.excel)l.push({...e.columnData.excel})}const n=(o,n=false)=>{let a={workbook:{columns:l},dataSource:o,fileName:`export.xlsx`,worker:n};let s=new x(a);s.build().then(()=>t(null)).catch(t=>{y.error(this.i18n.getText("export_failed"));e(t)}).finally(()=>s.destroy())};if(this.data.toolbar.excel==1)n(this.table.getBinding("items"),true);else{let t={};for(let e in this.data.itemsBinding.parameters)t["$"+e]=this.data.itemsBinding.parameters[e];this.data.model.read(this.data.itemsBinding.path,{urlParameters:t,filters:this.filters,sorters:this.sorter,success:t=>n(t.results),error:t=>{y.error(this.i18n.getText("export_failed"));e(t)}})}return o};generateTable=()=>{let e=this.data;this.columnElements=[];this.cellElements=[];this.colP13nMap={};this.colNonP13n=[];for(let t of e.columns){let e={columnData:t,columnElement:this.generateColumn(t,this.colNonP13n.length),cellElement:this.genereateCell(t)};this.columnElements.push(e.columnElement);this.cellElements.push(e.cellElement);if(t.p13n)this.colP13nMap[t.p13n.key]=e;else this.colNonP13n.push(e)}let o=e.columnListItem||{};this.cellContainer=new l({cells:this.cellElements,...o});this.table=new t(e.id,{columns:this.columnElements,noData:new p,...e.properties});this.table.setModel(e.model);this.refreshBinding()};handelStateChange=t=>{if(t&&t.getParameter&&t.getParameter("control")==this.table){let e=t.getParameter("state");if(e){let t=this.columnsFromState(e);for(let o=0;o<t.length;o++){let l=t[o];l.setVisible(true).setWidth(l.data("default-width"));if(e.Sorter&&e.Sorter.length>0){let t=l.data("key");let o=e.Sorter.find(e=>e.key==t);if(o)l.setSortIndicator(o.descending?c.SortOrder.Descending:c.SortOrder.Ascending);else l.setSortIndicator(c.SortOrder.None)}}let o=this.cellsFromState(e);this.sorter=this.sorterFromState(e);this.table.getColumns(true).forEach(t=>this.table.removeColumn(t));t.forEach((t,e)=>this.table.insertColumn(t,e));this.cellContainer.getCells().forEach(t=>this.cellContainer.removeCell(t));o.forEach((t,e)=>this.cellContainer.insertCell(t,e));this.refreshBinding()}}this.p13n.detachStateChange(this.handelStateChange)};showP13n=()=>{let t=this.data;this.p13n.attachStateChange(this.handelStateChange);return this.p13n.show(this.table,Object.keys(t.toolbar.p13n).filter(e=>t.toolbar.p13n[e]),this.table)};sorterFromState=t=>{if(!t||typeof t.Sorter=="undefined")return this.sorter;let e=[];let o=t.Groups&&t.Groups.length>0?t.Groups[0].key:null;let l=false;for(let n of t.Sorter){if(n.key==o)l=true;e.push(new d(this.colP13nMap[n.key].columnData.p13n.path,n.descending,n.key==o?this.colP13nMap[n.key].columnData.groupFunction||true:false))}if(o&&!l){e.push(new d(this.colP13nMap[o].columnData.p13n.path,false,this.colP13nMap[o].columnData.groupFunction||true))}return e};columnsFromState=t=>{if(!t||typeof t.Columns=="undefined")return this.columnElements;let e=[];for(let o of t.Columns)e.push(this.colP13nMap[o.key].columnElement);for(let t of this.colNonP13n)e.push(t.columnElement);return e};cellsFromState=t=>{if(!t||typeof t.Columns=="undefined")return this.cellElements;let e=[];for(let o of t.Columns)e.push(this.colP13nMap[o.key].cellElement);for(let t of this.colNonP13n)e.push(t.cellElement);return e};registerP13n=()=>{let t=this.data;let e=[];for(let o of t.columns){if(o.p13n)e.push({...o.p13n})}let o=n.getInstance();o.register(this.table,{helper:new h(e),controller:{Columns:new a({targetAggregation:"columns",control:this.table}),Sorter:new s({control:this.table}),Groups:new r({control:this.table})}});return o};generateColumn=(t,l)=>{if(typeof t.header.header=="string")t.header.header=new o({text:t.header.header});let n=new e(t.id,t.header);n.data("default-width",t.header.width);if(t.p13n&&t.p13n.key)n.data("key",t.p13n.key);else n.data("index",l);return n};genereateCell=t=>{let e=null;if(t.cell.control){e=t.cell.control}else{e=new o;e.bindText(t.cell.bindingPath)}return e}}});
//# sourceMappingURL=Table.js.map