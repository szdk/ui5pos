sap.ui.define(["ui5pos/szdk/controller/BaseController","ui5pos/szdk/controller/util/RouteEvent","ui5pos/szdk/controller/util/F4Help","sap/ui/model/json/JSONModel","sap/ui/core/Core"],function(e,t,i,r,s){"use strict";var o=null;return e.extend("ui5pos.szdk.controller.product.View",{productID:null,onInit:function(){e.prototype.onInit.apply(this,arguments);window.t=this.getView();o=this;this.mainModel=new r({editting:false,productData:{}});this.getView().setModel(this.mainModel,"model");this.getView().setBusyIndicatorDelay(0);this.comp.szdk_serviceCreated.then(e=>e.attachRequestSent(()=>this.getView().setBusy(true)));this.comp.szdk_serviceCreated.then(e=>e.attachRequestCompleted(()=>this.getView().setBusy(false)));this.comp.getRouter().getRoute("view_product").attachPatternMatched(this.patternMatched.bind(this));let t=s.getMessageManager();t.registerObject(this.byId("product_input_name"),true);t.registerObject(this.byId("product_input_category"),true);t.registerObject(this.byId("product_input_supplier"),true);t.registerObject(this.byId("product_input_qpu"),true);t.registerObject(this.byId("product_input_unit_price"),true);t.registerObject(this.byId("product_input_in_stock"),true);t.registerObject(this.byId("product_input_reorder_level"),true)},onValueHelpCategory:function(){i.f4Table.bind(this)(this.comp.getModel("service"),"/Categories",[{path:"CategoryName",label:this.i18n.getText("category_name")}],[{path:"CategoryID",label:this.i18n.getText("category_id")},{path:"CategoryName",label:this.i18n.getText("name")}],["CategoryID","CategoryName"],this.i18n.getText("category_select_single")).then(e=>{if(!e||e.length==0)return;let t=parseInt(e[0].CategoryID);if(t){this.byId("product_input_category").setValue(t).setValueState(sap.ui.core.ValueState.None);this.byId("product_category_name").setValue(e[0].CategoryName)}})},onValueHelpSupplier:function(){i.f4Table.bind(this)(this.comp.getModel("service"),"/Suppliers",[{path:"CompanyName",label:this.i18n.getText("supplier_company_name")}],[{path:"SupplierID",label:this.i18n.getText("supplier_id")},{path:"CompanyName",label:this.i18n.getText("supplier_company_name")}],["SupplierID","CompanyName"],this.i18n.getText("supplier_select_single")).then(e=>{if(!e||e.length==0)return;let t=parseInt(e[0].SupplierID);if(t){this.byId("product_input_supplier").setValue(t).setValueState(sap.ui.core.ValueState.None);this.byId("product_supplier_name").setValue(e[0].CompanyName)}})},onSave:function(){if(!this.mainModel.getProperty("/editting"))return;for(let e of["product_input_name","product_input_qpu","product_input_unit_price","product_input_in_stock","product_input_reorder_level"]){let t=this.byId(e);try{let e=t.getBinding("value");let i=e?e.getType():null;if(i)i.validateValue(t.getValue())}catch(e){t.setValueState(sap.ui.core.ValueState.Error);this.showErrorDialog({message:this.i18n.getText("input_submit_error")});return}}this.categoryIDCheck().then(()=>this.supplierIDCheck()).then(()=>{let e={ProductName:this.mainModel.getProperty("/productData/ProductName"),SupplierID:parseInt(this.mainModel.getProperty("/productData/SupplierID")),CategoryID:parseInt(this.mainModel.getProperty("/productData/CategoryID")),QuantityPerUnit:this.mainModel.getProperty("/productData/QuantityPerUnit"),UnitPrice:parseFloat(this.mainModel.getProperty("/productData/UnitPrice")),UnitsInStock:parseInt(this.mainModel.getProperty("/productData/UnitsInStock")),ReorderLevel:parseInt(this.mainModel.getProperty("/productData/ReorderLevel"))};let t=`/Products(${this.productID})`;console.log({action:"update",path:t,data:e});this.comp.getModel("service").update(t,e,{success:()=>{this.refreshBinding();this.showSuccessDialog({message:this.i18n.getText("data_saved_description")})},error:e=>this.showErrorDialog({message:e.message})})}).catch(()=>this.showErrorDialog({message:this.i18n.getText("input_submit_error")}))},onCategoryChange:function(){this.categoryIDCheck().catch(()=>{})},onSupplierChange:function(){this.supplierIDCheck().catch(()=>{})},categoryIDCheck:function(){let e=()=>{},t=()=>{};let i=new Promise((i,r)=>{e=i;t=r});const r=()=>{a.setValueState(sap.ui.core.ValueState.None)};const s=(e,t)=>{a.setValueStateText(this.i18n.getText(e,t));a.setValueState(sap.ui.core.ValueState.Error)};let o=this.byId("product_category_name");o.setValue("");let a=this.byId("product_input_category");let n=parseInt(a.getValue());if(!n||n<=0){s("input_invalid_category_id");t(n);return i}this.comp.getModel("service").read(`/Categories(${n})`,{success:t=>{if(t&&t.CategoryName)o.setValue(t.CategoryName);e(t);r()},error:e=>{t(n);s("input_invalid_category_id")}});return i},supplierIDCheck:function(){let e=()=>{},t=()=>{};let i=new Promise((i,r)=>{e=i;t=r});const r=()=>{a.setValueState(sap.ui.core.ValueState.None)};const s=(e,t)=>{a.setValueStateText(this.i18n.getText(e,t));a.setValueState(sap.ui.core.ValueState.Error)};let o=this.byId("product_supplier_name");o.setValue("");let a=this.byId("product_input_supplier");let n=parseInt(a.getValue());if(!n||n<=0){s("input_invalid_supplier_id");t(n);return i}this.comp.getModel("service").read(`/Suppliers(${n})`,{success:t=>{if(t&&t.CompanyName)o.setValue(t.CompanyName);e(t);r()},error:e=>{t(n);s("input_invalid_supplier_id")}});return i},onToggleEdit:function(e){if(!this.mainModel.getProperty("/editting")){if(!this.productID)return;const e=e=>{this.categoryIDCheck().catch(()=>{});this.supplierIDCheck().catch(()=>{});this.byId("product_view_page").setHeaderExpanded(true);this.mainModel.setProperty("/editting",true)};this.refreshBinding(e)}else{this.mainModel.setProperty("/editting",false)}},onToggleDiscontinue:function(){let e=this.comp.getModel("service");let t={Discontinued:!this.mainModel.getProperty("/productData/Discontinued")};let i=`/Products(${this.productID})`;console.log({action:"update",path:i,data:t});e.update(i,t,{success:()=>{this.refreshBinding()},error:e=>this.showErrorDialog({message:e.message})})},onDelete:function(){let e=this.comp.getModel("service");const t=()=>{e.remove(`/Products(${this.productID})`,{success:()=>{this.showSuccessDialog({message:this.i18n.getText("product_has_been_deleted"),onClose:()=>{this.comp.getRouter().navTo("products")}})},error:this.showErrorDialog})};e.read(`/Products(${this.productID})/Order_Details/$count`,{success:e=>{if(parseInt(e)>0){this.showInfoDialog({title:this.i18n.getText("product_in_use"),message:this.i18n.getText("product_cannot_delete_desc",[e])})}else{this.showErrorDialog({title:this.i18n.getText("confirm_delete"),message:this.i18n.getText("product_confirm_delete"),onConfirm:t})}},error:e=>this.showErrorDialog({message:e.message})})},refreshBinding:function(e=null,t=null,i=false){if(!t)t=e=>{this.showErrorDialog({message:e.message})};const r=t=>{if(!t||parseInt(t.ProductID)!==parseInt(this.productID)){this.showErrorDialog();return}t={ProductID:t.ProductID,ProductName:t.ProductName,SupplierID:t.SupplierID,CategoryID:t.CategoryID,QuantityPerUnit:t.QuantityPerUnit,UnitPrice:t.UnitPrice,UnitsInStock:t.UnitsInStock,UnitsOnOrder:t.UnitsOnOrder,ReorderLevel:t.ReorderLevel,Discontinued:t.Discontinued};this.mainModel.setProperty("/productData",t);if(e)e(t)};let s=!i?false:this.comp.getModel("service").getObject("",this.getView().getBindingContext("service"));if(!s||parseInt(s.ProductID)!==parseInt(this.productID))this.comp.getModel("service").read(`/Products(${this.productID})`,{urlParameters:{$expand:"Category,Supplier"},success:r,error:t});else r(s)},patternMatched:function(e){if(!t.defaultPatternMatched.apply(this,[e]))return;this.getView().getModel("nav").setProperty("/sideNav/selectedKey",`nav_item_route_products`);this.mainModel.setProperty("/editting",false);this.mainModel.setProperty("/productData",{});this.productID=null;const i=()=>{this.comp.getRouter().getTarget("notFound").display()};let r=e.getParameter("arguments");let s=r&&r.id&&(""+r.id).length>0?r.id:null;if(s){this.comp.getModel("service").createBindingContext(`/Products(${s})`,{expand:"Category,Supplier,Order_Details"},e=>{if(!e){i();return}this.productID=s;this.getView().setBindingContext(e,"service");this.refreshBinding(null,null,true)},true)}else{i()}},onOpenAction:function(e){let t=e.getSource();this.getView().byId("view_product_actionSheet").openBy(t)}})});
//# sourceMappingURL=View.controller.js.map