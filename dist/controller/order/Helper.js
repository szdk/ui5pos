sap.ui.define(["ui5pos/szdk/controller/customer/CustomerHelper","ui5pos/szdk/controller/order/PrintTemplate"],function(e,t){"use strict";let r={print:function(e){let r=e.model;let o=e.order_id;let s=e.i18n;let d=()=>{},i=()=>{};let u=new Promise((e,t)=>{d=e;i=t});r.read(`/Orders(${o})`,{success:e=>{t.template1(e,s);d()},error:i,urlParameters:{$expand:"Customer,Order_Details,Order_Details/Product"}});return u},create:function(t,o,s){let d=()=>{},i=()=>{};let u=new Promise((e,t)=>{d=e;i=t});if(!t.CustomerID){return e.create.bind(this)(s).then(e=>{if(!e||!e.CustomerID){throw new Error({message:"Customer creation failed",data:e})}else{t={...t};t.CustomerID=e.CustomerID;return r.create.bind(this)(t,o)}})}if(!t.OrderID&&(this.comp.getModel("settings").getProperty("/odata/useMock")||this.comp.getModel("settings").getProperty("/odata/generateID"))){return this.getMaxValue("/Orders","OrderID").then(e=>{if(parseInt(e)){t={...t};t.OrderID=parseInt(e)+1;return r.create.bind(this)(t,o)}else throw new Error("max order id fetch failed")});return u}let n={};for(let e of o){if(!n[e.ProductID]){n[e.ProductID]={...e}}else{n[e.ProductID].Quantity+=e.Quantity}}o=[];for(let e in n){o.push({...n[e]})}t.Freight=0;for(let e of o)t.Freight+=e.UnitPrice*e.Quantity*(1-e.Discount);let a=this.comp.getModel("service");a.create("/Orders",t,{success:e=>{if(!e||!parseInt(e.OrderID)){i({message:"order creation failed",dataReturned:e});return}let t=this.comp.getModel("settings").getProperty("/odata/useMock")||this.comp.getModel("settings").getProperty("/odata/updateQuantity");let r={};const s=()=>{for(let s of o){s={...s};s.OrderID=parseInt(e.OrderID);a.createEntry("/Order_Details",{properties:s});if(t&&r[s.ProductID]){a.update(`/Products(${s.ProductID})`,{UnitsInStock:Math.max(0,(parseInt(r[s.ProductID].UnitsInStock)||0)-s.Quantity)},{groupId:"co_updt_prod"})}}a.submitChanges({success:t=>{d(e)},error:i})};if(t){let e=[];for(let t of o)e.push(t.ProductID);this.fetchProducts(e).then(e=>{if(e&&e.length>0){for(let t of e){r[t.ProductID]=t}}s()}).catch(()=>s())}else s()},error:i});return u},update:function(t,o,s){let d=()=>{},i=()=>{};let u=new Promise((e,t)=>{d=e;i=t});if(!t.OrderID){i({message:"OrderID not provided",order:t});return u}if(!t.CustomerID){return e.create.bind(this)(s).then(e=>{if(!e||!e.CustomerID){throw new Error({message:"Customer creation failed",data:e})}else{t={...t};t.CustomerID=e.CustomerID;return r.update.bind(this)(t,o)}})}let n={};for(let e of o){if(!n[e.ProductID]){n[e.ProductID]={...e}}else{n[e.ProductID].Quantity+=e.Quantity}}o=[];for(let e in n){o.push({OrderID:t.OrderID,...n[e]})}t.Freight=0;for(let e of o)t.Freight+=e.UnitPrice*e.Quantity*(1-e.Discount);let a=this.comp.getModel("service");let c={};let l={};let p={create:[],update:[],delete:[]};let I={};let f=this.comp.getModel("settings").getProperty("/odata/useMock")||this.comp.getModel("settings").getProperty("/odata/updateQuantity");this.fetchOrder(t.OrderID).then(e=>e.Order_Details&&e.Order_Details.results||[]).then(e=>{for(let t of e)c[t.ProductID]=t;for(let e of o)l[e.ProductID]=e;for(let e in c){if(!l[e])p.delete.push(e)}for(let e in l){if(!c[e])p.create.push(e);else p.update.push(e)}if(!f){return}return this.fetchProducts([...p.create,...p.update,...p.delete]).then(e=>e||[]).then(e=>{for(let t of e)I[t.ProductID]=t})}).then(()=>{for(let e of p.delete){a.remove(`/Order_Details(OrderID=${t.OrderID},ProductID=${e})`,{groupId:"co_del_itm"});if(f&&I[e]&&c[e])a.update(`/Products(${e})`,{UnitsInStock:Math.max(0,(parseInt(I[e].UnitsInStock)||0)+(c[e].Quantity||0))},{groupId:"co_updt_prod"})}for(let e of p.create){a.createEntry("/Order_Details",{properties:{...l[e]},groupId:"co_crt_itm"});if(f&&I[e])a.update(`/Products(${e})`,{UnitsInStock:Math.max(0,(parseInt(I[e].UnitsInStock)||0)-(l[e].Quantity||0))},{groupId:"co_updt_prod"})}for(let e of p.update){a.update(`/Order_Details(OrderID=${t.OrderID},ProductID=${e})`,{...l[e]},{groupId:"co_updt_itm"});if(f&&I[e])a.update(`/Products(${e})`,{UnitsInStock:Math.max(0,(parseInt(I[e].UnitsInStock)||0)-(l[e].Quantity||0)+(c[e].Quantity||0))},{groupId:"co_updt_prod"})}a.submitChanges({success:e=>{a.update(`/Orders(${t.OrderID})`,{...t},{success:e=>{d(t)},error:i})},error:i})}).catch(i);return u},delete:function(e){let t=()=>{},r=()=>{};let o=new Promise((e,o)=>{t=e;r=o});let s=e.model;s.read(`/Orders(${e.orderId})`,{success:o=>{for(let t of o.Order_Details&&o.Order_Details.results||[])s.remove(`/Order_Details(OrderID=${e.orderId},ProductID=${t.ProductID})`,{groupId:"co_del_itm"});s.remove(`/Orders(${e.orderId})`,{groupId:"co_del_itm"});s.submitChanges({success:t,error:r})},error:r,urlParameters:{$expand:"Customer,Order_Details,Order_Details/Product"}});return o}};return r});
//# sourceMappingURL=Helper.js.map