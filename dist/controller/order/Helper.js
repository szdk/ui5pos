sap.ui.define(["ui5pos/szdk/controller/customer/CustomerHelper"],function(e){"use strict";let t={create:function(r,o,s){let d=()=>{},u=()=>{};let i=new Promise((e,t)=>{d=e;u=t});if(!r.CustomerID){return e.create.bind(this)(s).then(e=>{if(!e||!e.CustomerID){throw new Error({message:"Customer creation failed",data:e})}else{r={...r};r.CustomerID=e.CustomerID;return t.create.bind(this)(r,o)}})}if(!r.OrderID&&(this.comp.getModel("settings").getProperty("/odata/useMock")||this.comp.getModel("settings").getProperty("/odata/generateID"))){return this.getMaxValue("/Orders","OrderID").then(e=>{if(parseInt(e)){r={...r};r.OrderID=parseInt(e)+1;return t.create.bind(this)(r,o)}else throw new Error("max order id fetch failed")});return i}let n={};for(let e of o){if(!n[e.ProductID]){n[e.ProductID]={...e}}else{n[e.ProductID].Quantity+=e.Quantity}}o=[];for(let e in n){o.push({...n[e]})}r.Freight=0;for(let e of o)r.Freight+=e.UnitPrice*e.Quantity*(1-e.Discount);let a=this.comp.getModel("service");a.create("/Orders",r,{success:e=>{if(!e||!parseInt(e.OrderID)){u({message:"order creation failed",dataReturned:e});return}let t=this.comp.getModel("settings").getProperty("/odata/useMock")||this.comp.getModel("settings").getProperty("/odata/updateQuantity");let r={};const s=()=>{for(let s of o){s={...s};s.OrderID=parseInt(e.OrderID);a.createEntry("/Order_Details",{properties:s});if(t&&r[s.ProductID]){a.update(`/Products(${s.ProductID})`,{UnitsInStock:Math.max(0,(parseInt(r[s.ProductID].UnitsInStock)||0)-s.Quantity)},{groupId:"co_updt_prod"})}}a.submitChanges({success:t=>{d(e)},error:u})};if(t){let e=[];for(let t of o)e.push(t.ProductID);this.fetchProducts(e).then(e=>{if(e&&e.length>0){for(let t of e){r[t.ProductID]=t}}s()}).catch(()=>s())}else s()},error:u});return i},update:function(r,o,s){let d=()=>{},u=()=>{};let i=new Promise((e,t)=>{d=e;u=t});if(!r.OrderID){u({message:"OrderID not provided",order:r});return i}if(!r.CustomerID){return e.create.bind(this)(s).then(e=>{if(!e||!e.CustomerID){throw new Error({message:"Customer creation failed",data:e})}else{r={...r};r.CustomerID=e.CustomerID;return t.update.bind(this)(r,o)}})}let n={};for(let e of o){if(!n[e.ProductID]){n[e.ProductID]={...e}}else{n[e.ProductID].Quantity+=e.Quantity}}o=[];for(let e in n){o.push({OrderID:r.OrderID,...n[e]})}r.Freight=0;for(let e of o)r.Freight+=e.UnitPrice*e.Quantity*(1-e.Discount);let a=this.comp.getModel("service");let c={};let l={};let I={create:[],update:[],delete:[]};let p={};let f=this.comp.getModel("settings").getProperty("/odata/useMock")||this.comp.getModel("settings").getProperty("/odata/updateQuantity");this.fetchOrder(r.OrderID).then(e=>e.Order_Details&&e.Order_Details.results||[]).then(e=>{for(let t of e)c[t.ProductID]=t;for(let e of o)l[e.ProductID]=e;for(let e in c){if(!l[e])I.delete.push(e)}for(let e in l){if(!c[e])I.create.push(e);else I.update.push(e)}if(!f){return}return this.fetchProducts([...I.create,...I.update,...I.delete]).then(e=>e||[]).then(e=>{for(let t of e)p[t.ProductID]=t})}).then(()=>{for(let e of I.delete){a.remove(`/Order_Details(OrderID=${r.OrderID},ProductID=${e})`,{groupId:"co_del_itm"});if(f&&p[e]&&c[e])a.update(`/Products(${e})`,{UnitsInStock:Math.max(0,(parseInt(p[e].UnitsInStock)||0)+(c[e].Quantity||0))},{groupId:"co_updt_prod"})}for(let e of I.create){a.createEntry("/Order_Details",{properties:{...l[e]},groupId:"co_crt_itm"});if(f&&p[e])a.update(`/Products(${e})`,{UnitsInStock:Math.max(0,(parseInt(p[e].UnitsInStock)||0)-(l[e].Quantity||0))},{groupId:"co_updt_prod"})}for(let e of I.update){a.update(`/Order_Details(OrderID=${r.OrderID},ProductID=${e})`,{...l[e]},{groupId:"co_updt_itm"});if(f&&p[e])a.update(`/Products(${e})`,{UnitsInStock:Math.max(0,(parseInt(p[e].UnitsInStock)||0)-(l[e].Quantity||0)+(c[e].Quantity||0))},{groupId:"co_updt_prod"})}a.submitChanges({success:e=>{a.update(`/Orders(${r.OrderID})`,{...r},{success:e=>{d(r)},error:u})},error:u})}).catch(u);return i},delete:function(e){let t=()=>{},r=()=>{};let o=new Promise((e,o)=>{t=e;r=o});let s=e.model;s.read(`/Orders(${e.orderId})`,{success:o=>{for(let t of o.Order_Details&&o.Order_Details.results||[])s.remove(`/Order_Details(OrderID=${e.orderId},ProductID=${t.ProductID})`,{groupId:"co_del_itm"});s.remove(`/Orders(${e.orderId})`,{groupId:"co_del_itm"});s.submitChanges({success:t,error:r})},error:r,urlParameters:{$expand:"Customer,Order_Details,Order_Details/Product"}});return o}};return t});
//# sourceMappingURL=Helper.js.map